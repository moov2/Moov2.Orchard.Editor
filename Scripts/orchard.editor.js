/*
** NOTE: This file is generated by Gulp and should not be edited directly!
** Any changes made directly to this file will be overwritten next time its asset group is processed by Gulp.
*/

window.Editor = window.Editor || {
    plugins: [],
    instances: []
};
/**
 * Editor can be toggled between code / visual editor.
 */

window.Editor.plugins.push({
    action: 'context',
    init: true,
    exec: function (instance) {
        var CSS_CODE_EDITOR = 'is-code-editor',
            CSS_VISUAL_EDITOR = 'is-visual-editor';

        /**
         * Returns the type of content
         */
        var getContentType = function () {
            return document.querySelector('.js-editor-content-type').value;
        };

        var sendMessage = function (msg) {
            msg.instanceId = instanceId;
            instance.$visualIFrame.contentWindow.postMessage(JSON.stringify(msg), '*');
        };

        var toggleCodeEditor = function () {
            instance.$el.classList.remove(CSS_VISUAL_EDITOR);
            instance.$el.classList.add(CSS_CODE_EDITOR);

            instance.$el.dispatchEvent(new Event('editor:valueUpdate'));
        };

        /**
         * Displays visual editor.
         */
        var toggleVisualEditor = function () {
            // send information to iframe.
            var message = {
                action: 'update',
                value: instance.$input.value,
                mediaPath: getContentType(),
                id: instance.id
            };

            instance.$visualIFrame.contentWindow.postMessage(JSON.stringify(message), '*');

            instance.$el.classList.remove(CSS_CODE_EDITOR);
            instance.$el.classList.add(CSS_VISUAL_EDITOR);
        };


        if (instance.$el.classList.contains(CSS_CODE_EDITOR)) {
            toggleVisualEditor();
            return;
        }

        toggleCodeEditor();
    }
});
/**
 * Switches editor between fullscreen and normal.
 */

window.Editor.plugins.push({
    action: 'toggle-fullscreen',
    init: false,
    exec: function (instance) {
        var CSS_FULLSCREEN = 'is-fullscreen',
            KEY_ESC = 27;

        var toggleFullscreen = function (e) {
            if (e && e.keyCode !== KEY_ESC) {
                return;
            }
    
            if (instance.$el.classList.contains(CSS_FULLSCREEN)) {
                instance.$el.classList.remove(CSS_FULLSCREEN);
    
                document.querySelector('html').style.overflow = '';
                window.removeEventListener('keydown', toggleFullscreen);
                return;
            }
    
            instance.$el.classList.add(CSS_FULLSCREEN);
            document.querySelector('html').style.overflow = 'hidden';
    
            window.addEventListener('keydown', toggleFullscreen);
        };

        toggleFullscreen();
    }
});
/**
 * Inserts media into the editor from the Orchard media library.
 */

window.Editor.plugins.push({
    action: 'insert-media',
    init: false,
    exec: function (instance) {
        var adminIndex = location.href.toLowerCase().indexOf("/admin/"),
            cachedScrollPosition = 0;

        if (adminIndex === -1) {
            return;
        }

        $.colorbox({
            href: location.href.substr(0, adminIndex) + "/Admin/Orchard.MediaLibrary?dialog=true",
            iframe: true,
            reposition: true,
            width: '90%',
            height: '90%',
            onLoad: function () {
                cachedScrollPosition = $('html').scrollTop();
                // hide the scrollbars from the main window
                $('html, body').css('overflow', 'hidden');
            },
            onClosed: function () {
                var selectedData = $.colorbox.selectedData;

                $('html, body').css('overflow', '');
                $('html').scrollTop(cachedScrollPosition);

                if(!selectedData || selectedData.length === 0) {
                    return;
                }
                
                instance.$el.dispatchEvent(new CustomEvent('editor:addMedia', {
                    detail: {
                        mediaItems: selectedData
                    }
                }));
            }
        });
    }
});
/**
 * Editor can be resized to custom height.
 */

window.Editor.plugins.push({
    action: 'resize',
    init: true,
    exec: function (instance) {
        var initialY, initialHeight,
            $resizer = instance.$el.querySelector('.js-editor-resizer');
        
        var dispose = function () {
            window.removeEventListener('mousemove', onDrag);
            window.removeEventListener('mouseup', dispose);
            instance.$visualIFrame.contentWindow.removeEventListener('mousemove', onIFrameDrag);
            instance.$visualIFrame.contentWindow.removeEventListener('mouseup', dispose);
        };

        var onDrag = function (e) {
            instance.$el.style.height = (initialHeight + (e.clientY - initialY)) + 'px';
        };

        var onIFrameDrag = function (e) {
            var boundingClientRect = instance.$visualIFrame.getBoundingClientRect(),
                evt = new CustomEvent('mousemove', { bubbles: true, cancelable: false });

            evt.clientX = e.clientX + boundingClientRect.left;
            evt.clientY = e.clientY + boundingClientRect.top;

            instance.$visualIFrame.dispatchEvent(evt);
        };

        $resizer.addEventListener('mousedown', function (e) {
            initialY = e.clientY;
            initialHeight = instance.$el.offsetHeight;

            window.addEventListener('mousemove', onDrag);
            window.addEventListener('mouseup', dispose);
            instance.$visualIFrame.contentWindow.addEventListener('mousemove', onIFrameDrag);
            instance.$visualIFrame.contentWindow.addEventListener('mouseup', dispose);
        });
    }
});
(function () {
    var editorInstance = function ($el) {
        var editor, session, $input;

        /**
         * Add provided media to editor, dictated by current ace editor selection state.
         */
        var addMedia = function (e) {
            if (!e || !e.detail || !e.detail.mediaItems) {
                return;
            }

            var alt, cursorPosition, line, url;

            for (var i = 0; i < e.detail.mediaItems.length; i++) {
                switch (e.detail.mediaItems[i].contentType.toLowerCase()) {
                    case 'document':
                        insertDocument(e.detail.mediaItems[i]);
                        break;
                    case 'image':
                        insertImage(e.detail.mediaItems[i]);
                        break;
                }
            }
        };

        /**
         * Filters out unwanted annotations (e.g. warning about doctype) due to common
         * case is the HTML being edited is not a full HTML document but a piece of HTML.
         */
        var filterAnnotation = function () {
            var annotations = session.getAnnotations() || [], i = len = annotations.length;

            while (i--) {
                if (/doctype first\. Expected/.test(annotations[i].text)) {
                    annotations.splice(i, 1);
                }
            }

            if (len > annotations.length) {
                session.setAnnotations(annotations);
            }
        };

        /**
         * Returns textarea that needs to get turned into Ace editor.
         */
        var getTextArea = function () {
            return $el.querySelector('.js-editor-code > textarea');
        };

        /**
         * Initialises Ace editor.
         */
        var init = function () {
            editor = ace.edit(getTextArea().id);
            session = editor.getSession();

            $input = $el.querySelector('.editor-input');

            editor.setTheme('ace/theme/monokai');
            editor.setShowPrintMargin(false);
            editor.$blockScrolling = Infinity;

            session.setMode('ace/mode/html');
            session.setUseWrapMode(true);

            session.on('changeAnnotation', filterAnnotation);
            session.on('change', update);

            $input.addEventListener('change', updateSession);
            $el.addEventListener('editor:valueUpdate', updateSession);
            $el.addEventListener('editor:addMedia', addMedia);
        };

        /**
         * Inserts hyperlink for document.
         */
        var insertDocument = function(asset) {
            var cursorPosition = editor.selection.getRange().start,
                line = editor.session.getLine(cursorPosition.row);

            // inserting media URL between two quotes
            if (line.substr(cursorPosition.column - 5, 5).toLowerCase() === 'href="') {
                editor.insert(asset.resource);
                return;
            }

            // inserting media URL with quotes
            if (line.substr(cursorPosition.column - 4, 4).toLowerCase() === 'href=') {
                editor.insert('"' + asset.resource + '"');
                return;
            }

            // ensure that the current cursor position warrants a complete anchor HTML
            // tag instead of the URL.
            var character = line.substr(cursorPosition.column - 1, 1).toLowerCase()

            if (character === '>' || character === '' || character === ' ') {
                editor.insert('<a href="' + asset.resource + '" title="' + asset.alternateText + '" class="" />\n');
                return;
            }

            editor.insert(asset.resource);        
        }

        /**
         * Inserts an image at the current cursor position.
         */
        var insertImage = function (image) {
            var cursorPosition = editor.selection.getRange().start,
                line = editor.session.getLine(cursorPosition.row);

            // inserting media URL between two quotes
            if (line.substr(cursorPosition.column - 5, 5).toLowerCase() === 'src="') {
                editor.insert(image.resource);
                return;
            }

            // inserting media URL with quotes
            if (line.substr(cursorPosition.column - 4, 4).toLowerCase() === 'src=') {
                editor.insert('"' + image.resource + '"');
                return;
            }

            // inserting media as an inline style
            if (line.substr(cursorPosition.column - 4, 4).toLowerCase() === 'url(') {
                editor.insert(image.resource);
                return;
            }

            // ensure that the current cursor position warrants a complete img HTML
            // tag instead of the URL.
            var character = line.substr(cursorPosition.column - 1, 1).toLowerCase()

            if (character === '>' || character === '' || character === ' ') {
                editor.insert('<img src="' + image.resource + '" alt="' + image.alternateText + '" class="" />\n');
                return;
            }

            editor.insert(image.resource);
        };

        /**
         * Updates hidden HTML input with latest content from Ace editor.
         */
        var update = function () {
            $input.value = session.getValue();
        };

        var updateSession = function () {
            session.setValue($input.value);
        };

        init();
    }

    /**
     * Initialises instances of the Ace editor.
     */
    var initialise = function () {
        var $editors = document.querySelectorAll('.js-editor');

        for (var i = 0; i < $editors.length; i++) {
            editorInstance($editors[i]);
        }
    };

    document.addEventListener('DOMContentLoaded', initialise);
})();
(function () {
    var editorInstance = function ($el) {
        var instanceId = $el.getAttribute('data-id'),
            $input;
    

        /**
         * Returns object representing instance.
         */
        var getInstance = function () {
            return {
                id: instanceId,
                $el: $el,
                $visualIFrame: $el.querySelector('.js-editor-visual-iframe'),
                $input: $input
            };
        }

        /**
         * User has clicked an action within the toolbar.
         */
        var handleAction = function (e) {
            var action = e.currentTarget.getAttribute('data-action'),
                plugins = window.Editor.plugins;

            for (var i = 0; i < plugins.length; i++) {
                if (plugins[i].action === action) {
                    plugins[i].exec(getInstance());
                    return;
                }
            }
        }

        /**
         * Initialises Medium editor.
         */
        var init = function () {
            $input = $el.querySelector('.editor-input');

            var $actions = $el.querySelectorAll('.js-toolbar-btn');

            for (var i = 0; i < $actions.length; i++) {
                $actions[i].addEventListener('click', handleAction);
            }

            window.addEventListener('message', onMessage);

            // loop over plugins and execute any that are flagged to
            // exec on initialise.
            for (var i = 0; i < window.Editor.plugins.length; i++) {
                if (window.Editor.plugins[i].init) {
                    window.Editor.plugins[i].exec(getInstance());
                }
            }
        };

        /**
         * Received a message from the iframe editor.
         */
        var onMessage = function (e) {
            if (e.data.id !== instanceId) {
                return;
            }

            if (e.data.action === 'update') {
                $input.value = html_beautify ? html_beautify(e.data.value, { wrap_line_length: 0 }) : e.data.value;
                $el.dispatchEvent(new Event('editor:valueUpdate'));
            }
        };

        init();
    }

    /**
     * Initialises instances of the Ace editor.
     */
    var initialise = function () {
        var $editors = document.querySelectorAll('.js-editor');

        for (var i = 0; i < $editors.length; i++) {
            editorInstance($editors[i]);
        }
    };

    document.addEventListener('DOMContentLoaded', initialise);
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9yY2hhcmQuZWRpdG9yLmpzIiwiZWRpdG9yLmNvbnRleHQuanMiLCJlZGl0b3IuZnVsbHNjcmVlbi5qcyIsImVkaXRvci5pbnNlcnRNZWRpYS5qcyIsImVkaXRvci5yZXNpemVyLmpzIiwib3JjaGFyZC5hY2UuanMiLCJvcmNoYXJkLmVkaXRvci5pbnN0YW5jZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsQUFMQTtBQUNBO0FBQ0E7QUFDQTtBQ0hBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3hEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDNUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDMUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN6S0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJvcmNoYXJkLmVkaXRvci5qcyIsInNvdXJjZXNDb250ZW50IjpbIndpbmRvdy5FZGl0b3IgPSB3aW5kb3cuRWRpdG9yIHx8IHtcbiAgICBwbHVnaW5zOiBbXSxcbiAgICBpbnN0YW5jZXM6IFtdXG59OyIsIi8qKlxuICogRWRpdG9yIGNhbiBiZSB0b2dnbGVkIGJldHdlZW4gY29kZSAvIHZpc3VhbCBlZGl0b3IuXG4gKi9cblxud2luZG93LkVkaXRvci5wbHVnaW5zLnB1c2goe1xuICAgIGFjdGlvbjogJ2NvbnRleHQnLFxuICAgIGluaXQ6IHRydWUsXG4gICAgZXhlYzogZnVuY3Rpb24gKGluc3RhbmNlKSB7XG4gICAgICAgIHZhciBDU1NfQ09ERV9FRElUT1IgPSAnaXMtY29kZS1lZGl0b3InLFxuICAgICAgICAgICAgQ1NTX1ZJU1VBTF9FRElUT1IgPSAnaXMtdmlzdWFsLWVkaXRvcic7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJldHVybnMgdGhlIHR5cGUgb2YgY29udGVudFxuICAgICAgICAgKi9cbiAgICAgICAgdmFyIGdldENvbnRlbnRUeXBlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5qcy1lZGl0b3ItY29udGVudC10eXBlJykudmFsdWU7XG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIHNlbmRNZXNzYWdlID0gZnVuY3Rpb24gKG1zZykge1xuICAgICAgICAgICAgbXNnLmluc3RhbmNlSWQgPSBpbnN0YW5jZUlkO1xuICAgICAgICAgICAgaW5zdGFuY2UuJHZpc3VhbElGcmFtZS5jb250ZW50V2luZG93LnBvc3RNZXNzYWdlKEpTT04uc3RyaW5naWZ5KG1zZyksICcqJyk7XG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIHRvZ2dsZUNvZGVFZGl0b3IgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpbnN0YW5jZS4kZWwuY2xhc3NMaXN0LnJlbW92ZShDU1NfVklTVUFMX0VESVRPUik7XG4gICAgICAgICAgICBpbnN0YW5jZS4kZWwuY2xhc3NMaXN0LmFkZChDU1NfQ09ERV9FRElUT1IpO1xuXG4gICAgICAgICAgICBpbnN0YW5jZS4kZWwuZGlzcGF0Y2hFdmVudChuZXcgRXZlbnQoJ2VkaXRvcjp2YWx1ZVVwZGF0ZScpKTtcbiAgICAgICAgfTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogRGlzcGxheXMgdmlzdWFsIGVkaXRvci5cbiAgICAgICAgICovXG4gICAgICAgIHZhciB0b2dnbGVWaXN1YWxFZGl0b3IgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAvLyBzZW5kIGluZm9ybWF0aW9uIHRvIGlmcmFtZS5cbiAgICAgICAgICAgIHZhciBtZXNzYWdlID0ge1xuICAgICAgICAgICAgICAgIGFjdGlvbjogJ3VwZGF0ZScsXG4gICAgICAgICAgICAgICAgdmFsdWU6IGluc3RhbmNlLiRpbnB1dC52YWx1ZSxcbiAgICAgICAgICAgICAgICBtZWRpYVBhdGg6IGdldENvbnRlbnRUeXBlKCksXG4gICAgICAgICAgICAgICAgaWQ6IGluc3RhbmNlLmlkXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpbnN0YW5jZS4kdmlzdWFsSUZyYW1lLmNvbnRlbnRXaW5kb3cucG9zdE1lc3NhZ2UoSlNPTi5zdHJpbmdpZnkobWVzc2FnZSksICcqJyk7XG5cbiAgICAgICAgICAgIGluc3RhbmNlLiRlbC5jbGFzc0xpc3QucmVtb3ZlKENTU19DT0RFX0VESVRPUik7XG4gICAgICAgICAgICBpbnN0YW5jZS4kZWwuY2xhc3NMaXN0LmFkZChDU1NfVklTVUFMX0VESVRPUik7XG4gICAgICAgIH07XG5cblxuICAgICAgICBpZiAoaW5zdGFuY2UuJGVsLmNsYXNzTGlzdC5jb250YWlucyhDU1NfQ09ERV9FRElUT1IpKSB7XG4gICAgICAgICAgICB0b2dnbGVWaXN1YWxFZGl0b3IoKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRvZ2dsZUNvZGVFZGl0b3IoKTtcbiAgICB9XG59KTsiLCIvKipcbiAqIFN3aXRjaGVzIGVkaXRvciBiZXR3ZWVuIGZ1bGxzY3JlZW4gYW5kIG5vcm1hbC5cbiAqL1xuXG53aW5kb3cuRWRpdG9yLnBsdWdpbnMucHVzaCh7XG4gICAgYWN0aW9uOiAndG9nZ2xlLWZ1bGxzY3JlZW4nLFxuICAgIGluaXQ6IGZhbHNlLFxuICAgIGV4ZWM6IGZ1bmN0aW9uIChpbnN0YW5jZSkge1xuICAgICAgICB2YXIgQ1NTX0ZVTExTQ1JFRU4gPSAnaXMtZnVsbHNjcmVlbicsXG4gICAgICAgICAgICBLRVlfRVNDID0gMjc7XG5cbiAgICAgICAgdmFyIHRvZ2dsZUZ1bGxzY3JlZW4gPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgaWYgKGUgJiYgZS5rZXlDb2RlICE9PSBLRVlfRVNDKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgIFxuICAgICAgICAgICAgaWYgKGluc3RhbmNlLiRlbC5jbGFzc0xpc3QuY29udGFpbnMoQ1NTX0ZVTExTQ1JFRU4pKSB7XG4gICAgICAgICAgICAgICAgaW5zdGFuY2UuJGVsLmNsYXNzTGlzdC5yZW1vdmUoQ1NTX0ZVTExTQ1JFRU4pO1xuICAgIFxuICAgICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2h0bWwnKS5zdHlsZS5vdmVyZmxvdyA9ICcnO1xuICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdG9nZ2xlRnVsbHNjcmVlbik7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgIFxuICAgICAgICAgICAgaW5zdGFuY2UuJGVsLmNsYXNzTGlzdC5hZGQoQ1NTX0ZVTExTQ1JFRU4pO1xuICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaHRtbCcpLnN0eWxlLm92ZXJmbG93ID0gJ2hpZGRlbic7XG4gICAgXG4gICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRvZ2dsZUZ1bGxzY3JlZW4pO1xuICAgICAgICB9O1xuXG4gICAgICAgIHRvZ2dsZUZ1bGxzY3JlZW4oKTtcbiAgICB9XG59KTsiLCIvKipcbiAqIEluc2VydHMgbWVkaWEgaW50byB0aGUgZWRpdG9yIGZyb20gdGhlIE9yY2hhcmQgbWVkaWEgbGlicmFyeS5cbiAqL1xuXG53aW5kb3cuRWRpdG9yLnBsdWdpbnMucHVzaCh7XG4gICAgYWN0aW9uOiAnaW5zZXJ0LW1lZGlhJyxcbiAgICBpbml0OiBmYWxzZSxcbiAgICBleGVjOiBmdW5jdGlvbiAoaW5zdGFuY2UpIHtcbiAgICAgICAgdmFyIGFkbWluSW5kZXggPSBsb2NhdGlvbi5ocmVmLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihcIi9hZG1pbi9cIiksXG4gICAgICAgICAgICBjYWNoZWRTY3JvbGxQb3NpdGlvbiA9IDA7XG5cbiAgICAgICAgaWYgKGFkbWluSW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAkLmNvbG9yYm94KHtcbiAgICAgICAgICAgIGhyZWY6IGxvY2F0aW9uLmhyZWYuc3Vic3RyKDAsIGFkbWluSW5kZXgpICsgXCIvQWRtaW4vT3JjaGFyZC5NZWRpYUxpYnJhcnk/ZGlhbG9nPXRydWVcIixcbiAgICAgICAgICAgIGlmcmFtZTogdHJ1ZSxcbiAgICAgICAgICAgIHJlcG9zaXRpb246IHRydWUsXG4gICAgICAgICAgICB3aWR0aDogJzkwJScsXG4gICAgICAgICAgICBoZWlnaHQ6ICc5MCUnLFxuICAgICAgICAgICAgb25Mb2FkOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgY2FjaGVkU2Nyb2xsUG9zaXRpb24gPSAkKCdodG1sJykuc2Nyb2xsVG9wKCk7XG4gICAgICAgICAgICAgICAgLy8gaGlkZSB0aGUgc2Nyb2xsYmFycyBmcm9tIHRoZSBtYWluIHdpbmRvd1xuICAgICAgICAgICAgICAgICQoJ2h0bWwsIGJvZHknKS5jc3MoJ292ZXJmbG93JywgJ2hpZGRlbicpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9uQ2xvc2VkOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNlbGVjdGVkRGF0YSA9ICQuY29sb3Jib3guc2VsZWN0ZWREYXRhO1xuXG4gICAgICAgICAgICAgICAgJCgnaHRtbCwgYm9keScpLmNzcygnb3ZlcmZsb3cnLCAnJyk7XG4gICAgICAgICAgICAgICAgJCgnaHRtbCcpLnNjcm9sbFRvcChjYWNoZWRTY3JvbGxQb3NpdGlvbik7XG5cbiAgICAgICAgICAgICAgICBpZighc2VsZWN0ZWREYXRhIHx8IHNlbGVjdGVkRGF0YS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpbnN0YW5jZS4kZWwuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ2VkaXRvcjphZGRNZWRpYScsIHtcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUl0ZW1zOiBzZWxlY3RlZERhdGFcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufSk7IiwiLyoqXG4gKiBFZGl0b3IgY2FuIGJlIHJlc2l6ZWQgdG8gY3VzdG9tIGhlaWdodC5cbiAqL1xuXG53aW5kb3cuRWRpdG9yLnBsdWdpbnMucHVzaCh7XG4gICAgYWN0aW9uOiAncmVzaXplJyxcbiAgICBpbml0OiB0cnVlLFxuICAgIGV4ZWM6IGZ1bmN0aW9uIChpbnN0YW5jZSkge1xuICAgICAgICB2YXIgaW5pdGlhbFksIGluaXRpYWxIZWlnaHQsXG4gICAgICAgICAgICAkcmVzaXplciA9IGluc3RhbmNlLiRlbC5xdWVyeVNlbGVjdG9yKCcuanMtZWRpdG9yLXJlc2l6ZXInKTtcbiAgICAgICAgXG4gICAgICAgIHZhciBkaXNwb3NlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG9uRHJhZyk7XG4gICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGRpc3Bvc2UpO1xuICAgICAgICAgICAgaW5zdGFuY2UuJHZpc3VhbElGcmFtZS5jb250ZW50V2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG9uSUZyYW1lRHJhZyk7XG4gICAgICAgICAgICBpbnN0YW5jZS4kdmlzdWFsSUZyYW1lLmNvbnRlbnRXaW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGRpc3Bvc2UpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBvbkRyYWcgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgaW5zdGFuY2UuJGVsLnN0eWxlLmhlaWdodCA9IChpbml0aWFsSGVpZ2h0ICsgKGUuY2xpZW50WSAtIGluaXRpYWxZKSkgKyAncHgnO1xuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBvbklGcmFtZURyYWcgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgdmFyIGJvdW5kaW5nQ2xpZW50UmVjdCA9IGluc3RhbmNlLiR2aXN1YWxJRnJhbWUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksXG4gICAgICAgICAgICAgICAgZXZ0ID0gbmV3IEN1c3RvbUV2ZW50KCdtb3VzZW1vdmUnLCB7IGJ1YmJsZXM6IHRydWUsIGNhbmNlbGFibGU6IGZhbHNlIH0pO1xuXG4gICAgICAgICAgICBldnQuY2xpZW50WCA9IGUuY2xpZW50WCArIGJvdW5kaW5nQ2xpZW50UmVjdC5sZWZ0O1xuICAgICAgICAgICAgZXZ0LmNsaWVudFkgPSBlLmNsaWVudFkgKyBib3VuZGluZ0NsaWVudFJlY3QudG9wO1xuXG4gICAgICAgICAgICBpbnN0YW5jZS4kdmlzdWFsSUZyYW1lLmRpc3BhdGNoRXZlbnQoZXZ0KTtcbiAgICAgICAgfTtcblxuICAgICAgICAkcmVzaXplci5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgaW5pdGlhbFkgPSBlLmNsaWVudFk7XG4gICAgICAgICAgICBpbml0aWFsSGVpZ2h0ID0gaW5zdGFuY2UuJGVsLm9mZnNldEhlaWdodDtcblxuICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG9uRHJhZyk7XG4gICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGRpc3Bvc2UpO1xuICAgICAgICAgICAgaW5zdGFuY2UuJHZpc3VhbElGcmFtZS5jb250ZW50V2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG9uSUZyYW1lRHJhZyk7XG4gICAgICAgICAgICBpbnN0YW5jZS4kdmlzdWFsSUZyYW1lLmNvbnRlbnRXaW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGRpc3Bvc2UpO1xuICAgICAgICB9KTtcbiAgICB9XG59KTsiLCIoZnVuY3Rpb24gKCkge1xuICAgIHZhciBlZGl0b3JJbnN0YW5jZSA9IGZ1bmN0aW9uICgkZWwpIHtcbiAgICAgICAgdmFyIGVkaXRvciwgc2Vzc2lvbiwgJGlucHV0O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBZGQgcHJvdmlkZWQgbWVkaWEgdG8gZWRpdG9yLCBkaWN0YXRlZCBieSBjdXJyZW50IGFjZSBlZGl0b3Igc2VsZWN0aW9uIHN0YXRlLlxuICAgICAgICAgKi9cbiAgICAgICAgdmFyIGFkZE1lZGlhID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgIGlmICghZSB8fCAhZS5kZXRhaWwgfHwgIWUuZGV0YWlsLm1lZGlhSXRlbXMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHZhciBhbHQsIGN1cnNvclBvc2l0aW9uLCBsaW5lLCB1cmw7XG5cbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZS5kZXRhaWwubWVkaWFJdGVtcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHN3aXRjaCAoZS5kZXRhaWwubWVkaWFJdGVtc1tpXS5jb250ZW50VHlwZS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2RvY3VtZW50JzpcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydERvY3VtZW50KGUuZGV0YWlsLm1lZGlhSXRlbXNbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ltYWdlJzpcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydEltYWdlKGUuZGV0YWlsLm1lZGlhSXRlbXNbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBGaWx0ZXJzIG91dCB1bndhbnRlZCBhbm5vdGF0aW9ucyAoZS5nLiB3YXJuaW5nIGFib3V0IGRvY3R5cGUpIGR1ZSB0byBjb21tb25cbiAgICAgICAgICogY2FzZSBpcyB0aGUgSFRNTCBiZWluZyBlZGl0ZWQgaXMgbm90IGEgZnVsbCBIVE1MIGRvY3VtZW50IGJ1dCBhIHBpZWNlIG9mIEhUTUwuXG4gICAgICAgICAqL1xuICAgICAgICB2YXIgZmlsdGVyQW5ub3RhdGlvbiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBhbm5vdGF0aW9ucyA9IHNlc3Npb24uZ2V0QW5ub3RhdGlvbnMoKSB8fCBbXSwgaSA9IGxlbiA9IGFubm90YXRpb25zLmxlbmd0aDtcblxuICAgICAgICAgICAgd2hpbGUgKGktLSkge1xuICAgICAgICAgICAgICAgIGlmICgvZG9jdHlwZSBmaXJzdFxcLiBFeHBlY3RlZC8udGVzdChhbm5vdGF0aW9uc1tpXS50ZXh0KSkge1xuICAgICAgICAgICAgICAgICAgICBhbm5vdGF0aW9ucy5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAobGVuID4gYW5ub3RhdGlvbnMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgc2Vzc2lvbi5zZXRBbm5vdGF0aW9ucyhhbm5vdGF0aW9ucyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJldHVybnMgdGV4dGFyZWEgdGhhdCBuZWVkcyB0byBnZXQgdHVybmVkIGludG8gQWNlIGVkaXRvci5cbiAgICAgICAgICovXG4gICAgICAgIHZhciBnZXRUZXh0QXJlYSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiAkZWwucXVlcnlTZWxlY3RvcignLmpzLWVkaXRvci1jb2RlID4gdGV4dGFyZWEnKTtcbiAgICAgICAgfTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogSW5pdGlhbGlzZXMgQWNlIGVkaXRvci5cbiAgICAgICAgICovXG4gICAgICAgIHZhciBpbml0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgZWRpdG9yID0gYWNlLmVkaXQoZ2V0VGV4dEFyZWEoKS5pZCk7XG4gICAgICAgICAgICBzZXNzaW9uID0gZWRpdG9yLmdldFNlc3Npb24oKTtcblxuICAgICAgICAgICAgJGlucHV0ID0gJGVsLnF1ZXJ5U2VsZWN0b3IoJy5lZGl0b3ItaW5wdXQnKTtcblxuICAgICAgICAgICAgZWRpdG9yLnNldFRoZW1lKCdhY2UvdGhlbWUvbW9ub2thaScpO1xuICAgICAgICAgICAgZWRpdG9yLnNldFNob3dQcmludE1hcmdpbihmYWxzZSk7XG4gICAgICAgICAgICBlZGl0b3IuJGJsb2NrU2Nyb2xsaW5nID0gSW5maW5pdHk7XG5cbiAgICAgICAgICAgIHNlc3Npb24uc2V0TW9kZSgnYWNlL21vZGUvaHRtbCcpO1xuICAgICAgICAgICAgc2Vzc2lvbi5zZXRVc2VXcmFwTW9kZSh0cnVlKTtcblxuICAgICAgICAgICAgc2Vzc2lvbi5vbignY2hhbmdlQW5ub3RhdGlvbicsIGZpbHRlckFubm90YXRpb24pO1xuICAgICAgICAgICAgc2Vzc2lvbi5vbignY2hhbmdlJywgdXBkYXRlKTtcblxuICAgICAgICAgICAgJGlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIHVwZGF0ZVNlc3Npb24pO1xuICAgICAgICAgICAgJGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2VkaXRvcjp2YWx1ZVVwZGF0ZScsIHVwZGF0ZVNlc3Npb24pO1xuICAgICAgICAgICAgJGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2VkaXRvcjphZGRNZWRpYScsIGFkZE1lZGlhKTtcbiAgICAgICAgfTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogSW5zZXJ0cyBoeXBlcmxpbmsgZm9yIGRvY3VtZW50LlxuICAgICAgICAgKi9cbiAgICAgICAgdmFyIGluc2VydERvY3VtZW50ID0gZnVuY3Rpb24oYXNzZXQpIHtcbiAgICAgICAgICAgIHZhciBjdXJzb3JQb3NpdGlvbiA9IGVkaXRvci5zZWxlY3Rpb24uZ2V0UmFuZ2UoKS5zdGFydCxcbiAgICAgICAgICAgICAgICBsaW5lID0gZWRpdG9yLnNlc3Npb24uZ2V0TGluZShjdXJzb3JQb3NpdGlvbi5yb3cpO1xuXG4gICAgICAgICAgICAvLyBpbnNlcnRpbmcgbWVkaWEgVVJMIGJldHdlZW4gdHdvIHF1b3Rlc1xuICAgICAgICAgICAgaWYgKGxpbmUuc3Vic3RyKGN1cnNvclBvc2l0aW9uLmNvbHVtbiAtIDUsIDUpLnRvTG93ZXJDYXNlKCkgPT09ICdocmVmPVwiJykge1xuICAgICAgICAgICAgICAgIGVkaXRvci5pbnNlcnQoYXNzZXQucmVzb3VyY2UpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gaW5zZXJ0aW5nIG1lZGlhIFVSTCB3aXRoIHF1b3Rlc1xuICAgICAgICAgICAgaWYgKGxpbmUuc3Vic3RyKGN1cnNvclBvc2l0aW9uLmNvbHVtbiAtIDQsIDQpLnRvTG93ZXJDYXNlKCkgPT09ICdocmVmPScpIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IuaW5zZXJ0KCdcIicgKyBhc3NldC5yZXNvdXJjZSArICdcIicpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gZW5zdXJlIHRoYXQgdGhlIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uIHdhcnJhbnRzIGEgY29tcGxldGUgYW5jaG9yIEhUTUxcbiAgICAgICAgICAgIC8vIHRhZyBpbnN0ZWFkIG9mIHRoZSBVUkwuXG4gICAgICAgICAgICB2YXIgY2hhcmFjdGVyID0gbGluZS5zdWJzdHIoY3Vyc29yUG9zaXRpb24uY29sdW1uIC0gMSwgMSkudG9Mb3dlckNhc2UoKVxuXG4gICAgICAgICAgICBpZiAoY2hhcmFjdGVyID09PSAnPicgfHwgY2hhcmFjdGVyID09PSAnJyB8fCBjaGFyYWN0ZXIgPT09ICcgJykge1xuICAgICAgICAgICAgICAgIGVkaXRvci5pbnNlcnQoJzxhIGhyZWY9XCInICsgYXNzZXQucmVzb3VyY2UgKyAnXCIgdGl0bGU9XCInICsgYXNzZXQuYWx0ZXJuYXRlVGV4dCArICdcIiBjbGFzcz1cIlwiIC8+XFxuJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBlZGl0b3IuaW5zZXJ0KGFzc2V0LnJlc291cmNlKTsgICAgICAgIFxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEluc2VydHMgYW4gaW1hZ2UgYXQgdGhlIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uLlxuICAgICAgICAgKi9cbiAgICAgICAgdmFyIGluc2VydEltYWdlID0gZnVuY3Rpb24gKGltYWdlKSB7XG4gICAgICAgICAgICB2YXIgY3Vyc29yUG9zaXRpb24gPSBlZGl0b3Iuc2VsZWN0aW9uLmdldFJhbmdlKCkuc3RhcnQsXG4gICAgICAgICAgICAgICAgbGluZSA9IGVkaXRvci5zZXNzaW9uLmdldExpbmUoY3Vyc29yUG9zaXRpb24ucm93KTtcblxuICAgICAgICAgICAgLy8gaW5zZXJ0aW5nIG1lZGlhIFVSTCBiZXR3ZWVuIHR3byBxdW90ZXNcbiAgICAgICAgICAgIGlmIChsaW5lLnN1YnN0cihjdXJzb3JQb3NpdGlvbi5jb2x1bW4gLSA1LCA1KS50b0xvd2VyQ2FzZSgpID09PSAnc3JjPVwiJykge1xuICAgICAgICAgICAgICAgIGVkaXRvci5pbnNlcnQoaW1hZ2UucmVzb3VyY2UpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gaW5zZXJ0aW5nIG1lZGlhIFVSTCB3aXRoIHF1b3Rlc1xuICAgICAgICAgICAgaWYgKGxpbmUuc3Vic3RyKGN1cnNvclBvc2l0aW9uLmNvbHVtbiAtIDQsIDQpLnRvTG93ZXJDYXNlKCkgPT09ICdzcmM9Jykge1xuICAgICAgICAgICAgICAgIGVkaXRvci5pbnNlcnQoJ1wiJyArIGltYWdlLnJlc291cmNlICsgJ1wiJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBpbnNlcnRpbmcgbWVkaWEgYXMgYW4gaW5saW5lIHN0eWxlXG4gICAgICAgICAgICBpZiAobGluZS5zdWJzdHIoY3Vyc29yUG9zaXRpb24uY29sdW1uIC0gNCwgNCkudG9Mb3dlckNhc2UoKSA9PT0gJ3VybCgnKSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmluc2VydChpbWFnZS5yZXNvdXJjZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBlbnN1cmUgdGhhdCB0aGUgY3VycmVudCBjdXJzb3IgcG9zaXRpb24gd2FycmFudHMgYSBjb21wbGV0ZSBpbWcgSFRNTFxuICAgICAgICAgICAgLy8gdGFnIGluc3RlYWQgb2YgdGhlIFVSTC5cbiAgICAgICAgICAgIHZhciBjaGFyYWN0ZXIgPSBsaW5lLnN1YnN0cihjdXJzb3JQb3NpdGlvbi5jb2x1bW4gLSAxLCAxKS50b0xvd2VyQ2FzZSgpXG5cbiAgICAgICAgICAgIGlmIChjaGFyYWN0ZXIgPT09ICc+JyB8fCBjaGFyYWN0ZXIgPT09ICcnIHx8IGNoYXJhY3RlciA9PT0gJyAnKSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmluc2VydCgnPGltZyBzcmM9XCInICsgaW1hZ2UucmVzb3VyY2UgKyAnXCIgYWx0PVwiJyArIGltYWdlLmFsdGVybmF0ZVRleHQgKyAnXCIgY2xhc3M9XCJcIiAvPlxcbicpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZWRpdG9yLmluc2VydChpbWFnZS5yZXNvdXJjZSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFVwZGF0ZXMgaGlkZGVuIEhUTUwgaW5wdXQgd2l0aCBsYXRlc3QgY29udGVudCBmcm9tIEFjZSBlZGl0b3IuXG4gICAgICAgICAqL1xuICAgICAgICB2YXIgdXBkYXRlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgJGlucHV0LnZhbHVlID0gc2Vzc2lvbi5nZXRWYWx1ZSgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHZhciB1cGRhdGVTZXNzaW9uID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgc2Vzc2lvbi5zZXRWYWx1ZSgkaW5wdXQudmFsdWUpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGluaXQoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXNlcyBpbnN0YW5jZXMgb2YgdGhlIEFjZSBlZGl0b3IuXG4gICAgICovXG4gICAgdmFyIGluaXRpYWxpc2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciAkZWRpdG9ycyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5qcy1lZGl0b3InKTtcblxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8ICRlZGl0b3JzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBlZGl0b3JJbnN0YW5jZSgkZWRpdG9yc1tpXSk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGluaXRpYWxpc2UpO1xufSkoKTsiLCIoZnVuY3Rpb24gKCkge1xuICAgIHZhciBlZGl0b3JJbnN0YW5jZSA9IGZ1bmN0aW9uICgkZWwpIHtcbiAgICAgICAgdmFyIGluc3RhbmNlSWQgPSAkZWwuZ2V0QXR0cmlidXRlKCdkYXRhLWlkJyksXG4gICAgICAgICAgICAkaW5wdXQ7XG4gICAgXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJldHVybnMgb2JqZWN0IHJlcHJlc2VudGluZyBpbnN0YW5jZS5cbiAgICAgICAgICovXG4gICAgICAgIHZhciBnZXRJbnN0YW5jZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgaWQ6IGluc3RhbmNlSWQsXG4gICAgICAgICAgICAgICAgJGVsOiAkZWwsXG4gICAgICAgICAgICAgICAgJHZpc3VhbElGcmFtZTogJGVsLnF1ZXJ5U2VsZWN0b3IoJy5qcy1lZGl0b3ItdmlzdWFsLWlmcmFtZScpLFxuICAgICAgICAgICAgICAgICRpbnB1dDogJGlucHV0XG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFVzZXIgaGFzIGNsaWNrZWQgYW4gYWN0aW9uIHdpdGhpbiB0aGUgdG9vbGJhci5cbiAgICAgICAgICovXG4gICAgICAgIHZhciBoYW5kbGVBY3Rpb24gPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgdmFyIGFjdGlvbiA9IGUuY3VycmVudFRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtYWN0aW9uJyksXG4gICAgICAgICAgICAgICAgcGx1Z2lucyA9IHdpbmRvdy5FZGl0b3IucGx1Z2lucztcblxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwbHVnaW5zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBsdWdpbnNbaV0uYWN0aW9uID09PSBhY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcGx1Z2luc1tpXS5leGVjKGdldEluc3RhbmNlKCkpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEluaXRpYWxpc2VzIE1lZGl1bSBlZGl0b3IuXG4gICAgICAgICAqL1xuICAgICAgICB2YXIgaW5pdCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICRpbnB1dCA9ICRlbC5xdWVyeVNlbGVjdG9yKCcuZWRpdG9yLWlucHV0Jyk7XG5cbiAgICAgICAgICAgIHZhciAkYWN0aW9ucyA9ICRlbC5xdWVyeVNlbGVjdG9yQWxsKCcuanMtdG9vbGJhci1idG4nKTtcblxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAkYWN0aW9ucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICRhY3Rpb25zW2ldLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgaGFuZGxlQWN0aW9uKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBvbk1lc3NhZ2UpO1xuXG4gICAgICAgICAgICAvLyBsb29wIG92ZXIgcGx1Z2lucyBhbmQgZXhlY3V0ZSBhbnkgdGhhdCBhcmUgZmxhZ2dlZCB0b1xuICAgICAgICAgICAgLy8gZXhlYyBvbiBpbml0aWFsaXNlLlxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB3aW5kb3cuRWRpdG9yLnBsdWdpbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAod2luZG93LkVkaXRvci5wbHVnaW5zW2ldLmluaXQpIHtcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LkVkaXRvci5wbHVnaW5zW2ldLmV4ZWMoZ2V0SW5zdGFuY2UoKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSZWNlaXZlZCBhIG1lc3NhZ2UgZnJvbSB0aGUgaWZyYW1lIGVkaXRvci5cbiAgICAgICAgICovXG4gICAgICAgIHZhciBvbk1lc3NhZ2UgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgaWYgKGUuZGF0YS5pZCAhPT0gaW5zdGFuY2VJZCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGUuZGF0YS5hY3Rpb24gPT09ICd1cGRhdGUnKSB7XG4gICAgICAgICAgICAgICAgJGlucHV0LnZhbHVlID0gaHRtbF9iZWF1dGlmeSA/IGh0bWxfYmVhdXRpZnkoZS5kYXRhLnZhbHVlLCB7IHdyYXBfbGluZV9sZW5ndGg6IDAgfSkgOiBlLmRhdGEudmFsdWU7XG4gICAgICAgICAgICAgICAgJGVsLmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KCdlZGl0b3I6dmFsdWVVcGRhdGUnKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgaW5pdCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpc2VzIGluc3RhbmNlcyBvZiB0aGUgQWNlIGVkaXRvci5cbiAgICAgKi9cbiAgICB2YXIgaW5pdGlhbGlzZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyICRlZGl0b3JzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmpzLWVkaXRvcicpO1xuXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgJGVkaXRvcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGVkaXRvckluc3RhbmNlKCRlZGl0b3JzW2ldKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgaW5pdGlhbGlzZSk7XG59KSgpOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
