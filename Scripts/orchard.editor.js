/*
** NOTE: This file is generated by Gulp and should not be edited directly!
** Any changes made directly to this file will be overwritten next time its asset group is processed by Gulp.
*/

(function () {
    var editorInstance = function ($el) {
        var editor, session, $input;

        /**
         * Add provided media to editor, dictated by current ace editor selection state.
         */
        var addMedia = function (e) {
            if (!e || !e.detail || !e.detail.mediaItems) {
                return;
            }

            var alt, cursorPosition, line, url;

            for (var i = 0; i < e.detail.mediaItems.length; i++) {
                switch (e.detail.mediaItems[i].contentType.toLowerCase()) {
                    case 'document':
                        insertDocument(e.detail.mediaItems[i]);
                        break;
                    case 'image':
                        insertImage(e.detail.mediaItems[i]);
                        break;
                }
            }
        };

        /**
         * Filters out unwanted annotations (e.g. warning about doctype) due to common
         * case is the HTML being edited is not a full HTML document but a piece of HTML.
         */
        var filterAnnotation = function () {
            var annotations = session.getAnnotations() || [], i = len = annotations.length;

            while (i--) {
                if (/doctype first\. Expected/.test(annotations[i].text)) {
                    annotations.splice(i, 1);
                }
            }

            if (len > annotations.length) {
                session.setAnnotations(annotations);
            }
        };

        /**
         * Returns textarea that needs to get turned into Ace editor.
         */
        var getTextArea = function () {
            return $el.querySelector('.js-editor-code > textarea');
        };

        /**
         * Initialises Ace editor.
         */
        var init = function () {
            editor = ace.edit(getTextArea().id);
            session = editor.getSession();

            $input = $el.querySelector('.editor-input');

            editor.setTheme('ace/theme/monokai');
            editor.setShowPrintMargin(false);
            editor.$blockScrolling = Infinity;

            session.setMode('ace/mode/html');
            session.setUseWrapMode(true);

            session.on('changeAnnotation', filterAnnotation);
            session.on('change', update);

            $input.addEventListener('change', updateSession);
            $el.addEventListener('editor:valueUpdate', updateSession);
            $el.addEventListener('editor:addMedia', addMedia);
        };

        /**
         * Inserts hyperlink for document.
         */
        var insertDocument = function(asset) {
            var cursorPosition = editor.selection.getRange().start,
                line = editor.session.getLine(cursorPosition.row);

            // inserting media URL between two quotes
            if (line.substr(cursorPosition.column - 5, 5).toLowerCase() === 'href="') {
                editor.insert(asset.resource);
                return;
            }

            // inserting media URL with quotes
            if (line.substr(cursorPosition.column - 4, 4).toLowerCase() === 'href=') {
                editor.insert('"' + asset.resource + '"');
                return;
            }

            // ensure that the current cursor position warrants a complete anchor HTML
            // tag instead of the URL.
            var character = line.substr(cursorPosition.column - 1, 1).toLowerCase()

            if (character === '>' || character === '' || character === ' ') {
                editor.insert('<a href="' + asset.resource + '" title="' + asset.alternateText + '" class="" />\n');
                return;
            }

            editor.insert(asset.resource);        
        }

        /**
         * Inserts an image at the current cursor position.
         */
        var insertImage = function (image) {
            var cursorPosition = editor.selection.getRange().start,
                line = editor.session.getLine(cursorPosition.row);

            // inserting media URL between two quotes
            if (line.substr(cursorPosition.column - 5, 5).toLowerCase() === 'src="') {
                editor.insert(image.resource);
                return;
            }

            // inserting media URL with quotes
            if (line.substr(cursorPosition.column - 4, 4).toLowerCase() === 'src=') {
                editor.insert('"' + image.resource + '"');
                return;
            }

            // inserting media as an inline style
            if (line.substr(cursorPosition.column - 4, 4).toLowerCase() === 'url(') {
                editor.insert(image.resource);
                return;
            }

            // ensure that the current cursor position warrants a complete img HTML
            // tag instead of the URL.
            var character = line.substr(cursorPosition.column - 1, 1).toLowerCase()

            if (character === '>' || character === '' || character === ' ') {
                editor.insert('<img src="' + image.resource + '" alt="' + image.alternateText + '" class="" />\n');
                return;
            }

            editor.insert(image.resource);
        };

        /**
         * Updates hidden HTML input with latest content from Ace editor.
         */
        var update = function () {
            $input.value = session.getValue();
        };

        var updateSession = function () {
            session.setValue($input.value);
        };

        init();
    }

    /**
     * Initialises instances of the Ace editor.
     */
    var initialise = function () {
        var $editors = document.querySelectorAll('.js-editor');

        for (var i = 0; i < $editors.length; i++) {
            editorInstance($editors[i]);
        }
    };

    document.addEventListener('DOMContentLoaded', initialise);
})();
(function () {
    var CSS_CODE_EDITOR = 'is-code-editor',
        CSS_VISUAL_EDITOR = 'is-visual-editor';

    var editorInstance = function ($el) {
        var $visualEditor, $visualEditorIFrame, $input, $resizer;

        /**
         * Returns the type of content
         */
        var getContentType = function () {
            return document.querySelector('.js-editor-content-type').value;
        };

        /**
         * User has clicked an action within the toolbar.
         */
        var handleAction = function (e) {
            var action = e.currentTarget.getAttribute('data-action');

            switch (action) {
                case 'insert-media':
                    openMediaPicker();
                    break;
                case 'toggle-code-editor':
                    toggleCodeEditor();
                    break;
                case 'toggle-visual-editor':
                    toggleVisualEditor();
                    break;
            }
        }

        /**
         * Initialises Medium editor.
         */
        var init = function () {
            $visualEditor = $el.querySelector('.js-editor-visual');
            $input = $el.querySelector('.editor-input');
            $visualEditorIFrame = $el.querySelector('.js-editor-visual-iframe');
            $resizer = $el.querySelector('.js-editor-resizer');

            var $actions = $el.querySelectorAll('.js-toolbar-btn');

            for (var i = 0; i < $actions.length; i++) {
                $actions[i].addEventListener('click', handleAction);
            }

            window.addEventListener('message', onMessage);

            toggleCodeEditor();
            setupResizer();
        };

        /**
         * Received a message from the iframe editor.
         */
        var onMessage = function (e) {
            if (e.data.action === 'update') {
                $input.value = html_beautify ? html_beautify(e.data.value, { wrap_line_length: 0 }) : e.data.value;
                $el.dispatchEvent(new Event('editor:valueUpdate'));
            }
        };

        /**
         * Opens media library picker.
         */
        var openMediaPicker = function () {
            var adminIndex = location.href.toLowerCase().indexOf("/admin/"),
                _this = this,
                url;

            if (adminIndex === -1) {
                return;
            }

            url = location.href.substr(0, adminIndex) + "/Admin/Orchard.MediaLibrary?dialog=true";

            $.colorbox({
                href: url,
                iframe: true,
                reposition: true,
                width: '90%',
                height: '90%',
                onLoad: function () {
                    // hide the scrollbars from the main window
                    $('html, body').css('overflow', 'hidden');
                },
                onClosed: function () {
                    var selectedData = $.colorbox.selectedData;

                    $('html, body').css('overflow', '');

                    if (selectedData.length === 0) {
                        return;
                    }
                    
                    $el.dispatchEvent(new CustomEvent('editor:addMedia', {
                        detail: {
                            mediaItems: selectedData
                        }
                    }));
                }
            });
        };

        var setupResizer = function () {
            var initialY, initialHeight;

            var dispose = function () {
                window.removeEventListener('mousemove', onDrag);
                window.removeEventListener('mouseup', dispose);
                $visualEditorIFrame.contentWindow.removeEventListener('mousemove', onIFrameDrag);
                $visualEditorIFrame.contentWindow.removeEventListener('mouseup', dispose);
            };

            var onDrag = function (e) {
                $el.style.height = (initialHeight + (e.clientY - initialY)) + 'px';
            };

            var onIFrameDrag = function (e) {
                var boundingClientRect = $visualEditorIFrame.getBoundingClientRect(),
                    evt = new CustomEvent('mousemove', { bubbles: true, cancelable: false });

                evt.clientX = e.clientX + boundingClientRect.left;
                evt.clientY = e.clientY + boundingClientRect.top;

                $visualEditorIFrame.dispatchEvent(evt);
            };

            $resizer.addEventListener('mousedown', function (e) {
                initialY = e.clientY;
                initialHeight = $el.offsetHeight;

                window.addEventListener('mousemove', onDrag);
                window.addEventListener('mouseup', dispose);
                $visualEditorIFrame.contentWindow.addEventListener('mousemove', onIFrameDrag);
                $visualEditorIFrame.contentWindow.addEventListener('mouseup', dispose);
            })
        };

        /**
         * Displays code editor.
         */
        var toggleCodeEditor = function () {
            $el.classList.remove(CSS_VISUAL_EDITOR);
            $el.classList.add(CSS_CODE_EDITOR);

            $el.dispatchEvent(new Event('editor:valueUpdate'));
        };

        /**
         * Displays visual editor.
         */
        var toggleVisualEditor = function () {
            // send information to iframe.
            sendMessage({
                action: 'update',
                value: $input.value,
                mediaPath: getContentType()
            });

            $el.classList.remove(CSS_CODE_EDITOR);
            $el.classList.add(CSS_VISUAL_EDITOR);
        };

        /**
         * Sends a message to the iframe.
         */
        var sendMessage = function (msg) {
            $visualEditorIFrame.contentWindow.postMessage(JSON.stringify(msg), '*');
        };

        init()
    }

    /**
     * Initialises instances of the Ace editor.
     */
    var initialise = function () {
        var $editors = document.querySelectorAll('.js-editor');

        for (var i = 0; i < $editors.length; i++) {
            editorInstance($editors[i]);
        }
    };

    document.addEventListener('DOMContentLoaded', initialise);
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9yY2hhcmQuZWRpdG9yLmpzIiwib3JjaGFyZC5hY2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEFDTEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBRHpLQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoib3JjaGFyZC5lZGl0b3IuanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIENTU19DT0RFX0VESVRPUiA9ICdpcy1jb2RlLWVkaXRvcicsXHJcbiAgICAgICAgQ1NTX1ZJU1VBTF9FRElUT1IgPSAnaXMtdmlzdWFsLWVkaXRvcic7XHJcblxyXG4gICAgdmFyIGVkaXRvckluc3RhbmNlID0gZnVuY3Rpb24gKCRlbCkge1xyXG4gICAgICAgIHZhciAkdmlzdWFsRWRpdG9yLCAkdmlzdWFsRWRpdG9ySUZyYW1lLCAkaW5wdXQsICRyZXNpemVyO1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBSZXR1cm5zIHRoZSB0eXBlIG9mIGNvbnRlbnRcclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgZ2V0Q29udGVudFR5cGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuanMtZWRpdG9yLWNvbnRlbnQtdHlwZScpLnZhbHVlO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFVzZXIgaGFzIGNsaWNrZWQgYW4gYWN0aW9uIHdpdGhpbiB0aGUgdG9vbGJhci5cclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgaGFuZGxlQWN0aW9uID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgdmFyIGFjdGlvbiA9IGUuY3VycmVudFRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtYWN0aW9uJyk7XHJcblxyXG4gICAgICAgICAgICBzd2l0Y2ggKGFjdGlvbikge1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnaW5zZXJ0LW1lZGlhJzpcclxuICAgICAgICAgICAgICAgICAgICBvcGVuTWVkaWFQaWNrZXIoKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3RvZ2dsZS1jb2RlLWVkaXRvcic6XHJcbiAgICAgICAgICAgICAgICAgICAgdG9nZ2xlQ29kZUVkaXRvcigpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAndG9nZ2xlLXZpc3VhbC1lZGl0b3InOlxyXG4gICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZpc3VhbEVkaXRvcigpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBJbml0aWFsaXNlcyBNZWRpdW0gZWRpdG9yLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciBpbml0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAkdmlzdWFsRWRpdG9yID0gJGVsLnF1ZXJ5U2VsZWN0b3IoJy5qcy1lZGl0b3ItdmlzdWFsJyk7XHJcbiAgICAgICAgICAgICRpbnB1dCA9ICRlbC5xdWVyeVNlbGVjdG9yKCcuZWRpdG9yLWlucHV0Jyk7XHJcbiAgICAgICAgICAgICR2aXN1YWxFZGl0b3JJRnJhbWUgPSAkZWwucXVlcnlTZWxlY3RvcignLmpzLWVkaXRvci12aXN1YWwtaWZyYW1lJyk7XHJcbiAgICAgICAgICAgICRyZXNpemVyID0gJGVsLnF1ZXJ5U2VsZWN0b3IoJy5qcy1lZGl0b3ItcmVzaXplcicpO1xyXG5cclxuICAgICAgICAgICAgdmFyICRhY3Rpb25zID0gJGVsLnF1ZXJ5U2VsZWN0b3JBbGwoJy5qcy10b29sYmFyLWJ0bicpO1xyXG5cclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAkYWN0aW9ucy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgJGFjdGlvbnNbaV0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBoYW5kbGVBY3Rpb24pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIG9uTWVzc2FnZSk7XHJcblxyXG4gICAgICAgICAgICB0b2dnbGVDb2RlRWRpdG9yKCk7XHJcbiAgICAgICAgICAgIHNldHVwUmVzaXplcigpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFJlY2VpdmVkIGEgbWVzc2FnZSBmcm9tIHRoZSBpZnJhbWUgZWRpdG9yLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciBvbk1lc3NhZ2UgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICBpZiAoZS5kYXRhLmFjdGlvbiA9PT0gJ3VwZGF0ZScpIHtcclxuICAgICAgICAgICAgICAgICRpbnB1dC52YWx1ZSA9IGh0bWxfYmVhdXRpZnkgPyBodG1sX2JlYXV0aWZ5KGUuZGF0YS52YWx1ZSwgeyB3cmFwX2xpbmVfbGVuZ3RoOiAwIH0pIDogZS5kYXRhLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgJGVsLmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KCdlZGl0b3I6dmFsdWVVcGRhdGUnKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBPcGVucyBtZWRpYSBsaWJyYXJ5IHBpY2tlci5cclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgb3Blbk1lZGlhUGlja2VyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgYWRtaW5JbmRleCA9IGxvY2F0aW9uLmhyZWYudG9Mb3dlckNhc2UoKS5pbmRleE9mKFwiL2FkbWluL1wiKSxcclxuICAgICAgICAgICAgICAgIF90aGlzID0gdGhpcyxcclxuICAgICAgICAgICAgICAgIHVybDtcclxuXHJcbiAgICAgICAgICAgIGlmIChhZG1pbkluZGV4ID09PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB1cmwgPSBsb2NhdGlvbi5ocmVmLnN1YnN0cigwLCBhZG1pbkluZGV4KSArIFwiL0FkbWluL09yY2hhcmQuTWVkaWFMaWJyYXJ5P2RpYWxvZz10cnVlXCI7XHJcblxyXG4gICAgICAgICAgICAkLmNvbG9yYm94KHtcclxuICAgICAgICAgICAgICAgIGhyZWY6IHVybCxcclxuICAgICAgICAgICAgICAgIGlmcmFtZTogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIHJlcG9zaXRpb246IHRydWUsXHJcbiAgICAgICAgICAgICAgICB3aWR0aDogJzkwJScsXHJcbiAgICAgICAgICAgICAgICBoZWlnaHQ6ICc5MCUnLFxyXG4gICAgICAgICAgICAgICAgb25Mb2FkOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaGlkZSB0aGUgc2Nyb2xsYmFycyBmcm9tIHRoZSBtYWluIHdpbmRvd1xyXG4gICAgICAgICAgICAgICAgICAgICQoJ2h0bWwsIGJvZHknKS5jc3MoJ292ZXJmbG93JywgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIG9uQ2xvc2VkOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGVjdGVkRGF0YSA9ICQuY29sb3Jib3guc2VsZWN0ZWREYXRhO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAkKCdodG1sLCBib2R5JykuY3NzKCdvdmVyZmxvdycsICcnKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGVjdGVkRGF0YS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICAkZWwuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ2VkaXRvcjphZGRNZWRpYScsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWlsOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUl0ZW1zOiBzZWxlY3RlZERhdGFcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIHNldHVwUmVzaXplciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGluaXRpYWxZLCBpbml0aWFsSGVpZ2h0O1xyXG5cclxuICAgICAgICAgICAgdmFyIGRpc3Bvc2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgb25EcmFnKTtcclxuICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZGlzcG9zZSk7XHJcbiAgICAgICAgICAgICAgICAkdmlzdWFsRWRpdG9ySUZyYW1lLmNvbnRlbnRXaW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgb25JRnJhbWVEcmFnKTtcclxuICAgICAgICAgICAgICAgICR2aXN1YWxFZGl0b3JJRnJhbWUuY29udGVudFdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZGlzcG9zZSk7XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICB2YXIgb25EcmFnID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgICRlbC5zdHlsZS5oZWlnaHQgPSAoaW5pdGlhbEhlaWdodCArIChlLmNsaWVudFkgLSBpbml0aWFsWSkpICsgJ3B4JztcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHZhciBvbklGcmFtZURyYWcgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGJvdW5kaW5nQ2xpZW50UmVjdCA9ICR2aXN1YWxFZGl0b3JJRnJhbWUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksXHJcbiAgICAgICAgICAgICAgICAgICAgZXZ0ID0gbmV3IEN1c3RvbUV2ZW50KCdtb3VzZW1vdmUnLCB7IGJ1YmJsZXM6IHRydWUsIGNhbmNlbGFibGU6IGZhbHNlIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGV2dC5jbGllbnRYID0gZS5jbGllbnRYICsgYm91bmRpbmdDbGllbnRSZWN0LmxlZnQ7XHJcbiAgICAgICAgICAgICAgICBldnQuY2xpZW50WSA9IGUuY2xpZW50WSArIGJvdW5kaW5nQ2xpZW50UmVjdC50b3A7XHJcblxyXG4gICAgICAgICAgICAgICAgJHZpc3VhbEVkaXRvcklGcmFtZS5kaXNwYXRjaEV2ZW50KGV2dCk7XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAkcmVzaXplci5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgaW5pdGlhbFkgPSBlLmNsaWVudFk7XHJcbiAgICAgICAgICAgICAgICBpbml0aWFsSGVpZ2h0ID0gJGVsLm9mZnNldEhlaWdodDtcclxuXHJcbiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgb25EcmFnKTtcclxuICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZGlzcG9zZSk7XHJcbiAgICAgICAgICAgICAgICAkdmlzdWFsRWRpdG9ySUZyYW1lLmNvbnRlbnRXaW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgb25JRnJhbWVEcmFnKTtcclxuICAgICAgICAgICAgICAgICR2aXN1YWxFZGl0b3JJRnJhbWUuY29udGVudFdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZGlzcG9zZSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogRGlzcGxheXMgY29kZSBlZGl0b3IuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIHRvZ2dsZUNvZGVFZGl0b3IgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICRlbC5jbGFzc0xpc3QucmVtb3ZlKENTU19WSVNVQUxfRURJVE9SKTtcclxuICAgICAgICAgICAgJGVsLmNsYXNzTGlzdC5hZGQoQ1NTX0NPREVfRURJVE9SKTtcclxuXHJcbiAgICAgICAgICAgICRlbC5kaXNwYXRjaEV2ZW50KG5ldyBFdmVudCgnZWRpdG9yOnZhbHVlVXBkYXRlJykpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIERpc3BsYXlzIHZpc3VhbCBlZGl0b3IuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIHRvZ2dsZVZpc3VhbEVkaXRvciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgLy8gc2VuZCBpbmZvcm1hdGlvbiB0byBpZnJhbWUuXHJcbiAgICAgICAgICAgIHNlbmRNZXNzYWdlKHtcclxuICAgICAgICAgICAgICAgIGFjdGlvbjogJ3VwZGF0ZScsXHJcbiAgICAgICAgICAgICAgICB2YWx1ZTogJGlucHV0LnZhbHVlLFxyXG4gICAgICAgICAgICAgICAgbWVkaWFQYXRoOiBnZXRDb250ZW50VHlwZSgpXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgJGVsLmNsYXNzTGlzdC5yZW1vdmUoQ1NTX0NPREVfRURJVE9SKTtcclxuICAgICAgICAgICAgJGVsLmNsYXNzTGlzdC5hZGQoQ1NTX1ZJU1VBTF9FRElUT1IpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFNlbmRzIGEgbWVzc2FnZSB0byB0aGUgaWZyYW1lLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciBzZW5kTWVzc2FnZSA9IGZ1bmN0aW9uIChtc2cpIHtcclxuICAgICAgICAgICAgJHZpc3VhbEVkaXRvcklGcmFtZS5jb250ZW50V2luZG93LnBvc3RNZXNzYWdlKEpTT04uc3RyaW5naWZ5KG1zZyksICcqJyk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaW5pdCgpXHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBJbml0aWFsaXNlcyBpbnN0YW5jZXMgb2YgdGhlIEFjZSBlZGl0b3IuXHJcbiAgICAgKi9cclxuICAgIHZhciBpbml0aWFsaXNlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciAkZWRpdG9ycyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5qcy1lZGl0b3InKTtcclxuXHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAkZWRpdG9ycy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBlZGl0b3JJbnN0YW5jZSgkZWRpdG9yc1tpXSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgaW5pdGlhbGlzZSk7XHJcbn0pKCk7IiwiKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBlZGl0b3JJbnN0YW5jZSA9IGZ1bmN0aW9uICgkZWwpIHtcclxuICAgICAgICB2YXIgZWRpdG9yLCBzZXNzaW9uLCAkaW5wdXQ7XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIEFkZCBwcm92aWRlZCBtZWRpYSB0byBlZGl0b3IsIGRpY3RhdGVkIGJ5IGN1cnJlbnQgYWNlIGVkaXRvciBzZWxlY3Rpb24gc3RhdGUuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIGFkZE1lZGlhID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgaWYgKCFlIHx8ICFlLmRldGFpbCB8fCAhZS5kZXRhaWwubWVkaWFJdGVtcykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB2YXIgYWx0LCBjdXJzb3JQb3NpdGlvbiwgbGluZSwgdXJsO1xyXG5cclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlLmRldGFpbC5tZWRpYUl0ZW1zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKGUuZGV0YWlsLm1lZGlhSXRlbXNbaV0uY29udGVudFR5cGUudG9Mb3dlckNhc2UoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2RvY3VtZW50JzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0RG9jdW1lbnQoZS5kZXRhaWwubWVkaWFJdGVtc1tpXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2ltYWdlJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0SW1hZ2UoZS5kZXRhaWwubWVkaWFJdGVtc1tpXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogRmlsdGVycyBvdXQgdW53YW50ZWQgYW5ub3RhdGlvbnMgKGUuZy4gd2FybmluZyBhYm91dCBkb2N0eXBlKSBkdWUgdG8gY29tbW9uXHJcbiAgICAgICAgICogY2FzZSBpcyB0aGUgSFRNTCBiZWluZyBlZGl0ZWQgaXMgbm90IGEgZnVsbCBIVE1MIGRvY3VtZW50IGJ1dCBhIHBpZWNlIG9mIEhUTUwuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIGZpbHRlckFubm90YXRpb24gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBhbm5vdGF0aW9ucyA9IHNlc3Npb24uZ2V0QW5ub3RhdGlvbnMoKSB8fCBbXSwgaSA9IGxlbiA9IGFubm90YXRpb25zLmxlbmd0aDtcclxuXHJcbiAgICAgICAgICAgIHdoaWxlIChpLS0pIHtcclxuICAgICAgICAgICAgICAgIGlmICgvZG9jdHlwZSBmaXJzdFxcLiBFeHBlY3RlZC8udGVzdChhbm5vdGF0aW9uc1tpXS50ZXh0KSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFubm90YXRpb25zLnNwbGljZShpLCAxKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGxlbiA+IGFubm90YXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgc2Vzc2lvbi5zZXRBbm5vdGF0aW9ucyhhbm5vdGF0aW9ucyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBSZXR1cm5zIHRleHRhcmVhIHRoYXQgbmVlZHMgdG8gZ2V0IHR1cm5lZCBpbnRvIEFjZSBlZGl0b3IuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIGdldFRleHRBcmVhID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gJGVsLnF1ZXJ5U2VsZWN0b3IoJy5qcy1lZGl0b3ItY29kZSA+IHRleHRhcmVhJyk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogSW5pdGlhbGlzZXMgQWNlIGVkaXRvci5cclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgaW5pdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgZWRpdG9yID0gYWNlLmVkaXQoZ2V0VGV4dEFyZWEoKS5pZCk7XHJcbiAgICAgICAgICAgIHNlc3Npb24gPSBlZGl0b3IuZ2V0U2Vzc2lvbigpO1xyXG5cclxuICAgICAgICAgICAgJGlucHV0ID0gJGVsLnF1ZXJ5U2VsZWN0b3IoJy5lZGl0b3ItaW5wdXQnKTtcclxuXHJcbiAgICAgICAgICAgIGVkaXRvci5zZXRUaGVtZSgnYWNlL3RoZW1lL21vbm9rYWknKTtcclxuICAgICAgICAgICAgZWRpdG9yLnNldFNob3dQcmludE1hcmdpbihmYWxzZSk7XHJcbiAgICAgICAgICAgIGVkaXRvci4kYmxvY2tTY3JvbGxpbmcgPSBJbmZpbml0eTtcclxuXHJcbiAgICAgICAgICAgIHNlc3Npb24uc2V0TW9kZSgnYWNlL21vZGUvaHRtbCcpO1xyXG4gICAgICAgICAgICBzZXNzaW9uLnNldFVzZVdyYXBNb2RlKHRydWUpO1xyXG5cclxuICAgICAgICAgICAgc2Vzc2lvbi5vbignY2hhbmdlQW5ub3RhdGlvbicsIGZpbHRlckFubm90YXRpb24pO1xyXG4gICAgICAgICAgICBzZXNzaW9uLm9uKCdjaGFuZ2UnLCB1cGRhdGUpO1xyXG5cclxuICAgICAgICAgICAgJGlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIHVwZGF0ZVNlc3Npb24pO1xyXG4gICAgICAgICAgICAkZWwuYWRkRXZlbnRMaXN0ZW5lcignZWRpdG9yOnZhbHVlVXBkYXRlJywgdXBkYXRlU2Vzc2lvbik7XHJcbiAgICAgICAgICAgICRlbC5hZGRFdmVudExpc3RlbmVyKCdlZGl0b3I6YWRkTWVkaWEnLCBhZGRNZWRpYSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogSW5zZXJ0cyBoeXBlcmxpbmsgZm9yIGRvY3VtZW50LlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciBpbnNlcnREb2N1bWVudCA9IGZ1bmN0aW9uKGFzc2V0KSB7XHJcbiAgICAgICAgICAgIHZhciBjdXJzb3JQb3NpdGlvbiA9IGVkaXRvci5zZWxlY3Rpb24uZ2V0UmFuZ2UoKS5zdGFydCxcclxuICAgICAgICAgICAgICAgIGxpbmUgPSBlZGl0b3Iuc2Vzc2lvbi5nZXRMaW5lKGN1cnNvclBvc2l0aW9uLnJvdyk7XHJcblxyXG4gICAgICAgICAgICAvLyBpbnNlcnRpbmcgbWVkaWEgVVJMIGJldHdlZW4gdHdvIHF1b3Rlc1xyXG4gICAgICAgICAgICBpZiAobGluZS5zdWJzdHIoY3Vyc29yUG9zaXRpb24uY29sdW1uIC0gNSwgNSkudG9Mb3dlckNhc2UoKSA9PT0gJ2hyZWY9XCInKSB7XHJcbiAgICAgICAgICAgICAgICBlZGl0b3IuaW5zZXJ0KGFzc2V0LnJlc291cmNlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gaW5zZXJ0aW5nIG1lZGlhIFVSTCB3aXRoIHF1b3Rlc1xyXG4gICAgICAgICAgICBpZiAobGluZS5zdWJzdHIoY3Vyc29yUG9zaXRpb24uY29sdW1uIC0gNCwgNCkudG9Mb3dlckNhc2UoKSA9PT0gJ2hyZWY9Jykge1xyXG4gICAgICAgICAgICAgICAgZWRpdG9yLmluc2VydCgnXCInICsgYXNzZXQucmVzb3VyY2UgKyAnXCInKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gZW5zdXJlIHRoYXQgdGhlIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uIHdhcnJhbnRzIGEgY29tcGxldGUgYW5jaG9yIEhUTUxcclxuICAgICAgICAgICAgLy8gdGFnIGluc3RlYWQgb2YgdGhlIFVSTC5cclxuICAgICAgICAgICAgdmFyIGNoYXJhY3RlciA9IGxpbmUuc3Vic3RyKGN1cnNvclBvc2l0aW9uLmNvbHVtbiAtIDEsIDEpLnRvTG93ZXJDYXNlKClcclxuXHJcbiAgICAgICAgICAgIGlmIChjaGFyYWN0ZXIgPT09ICc+JyB8fCBjaGFyYWN0ZXIgPT09ICcnIHx8IGNoYXJhY3RlciA9PT0gJyAnKSB7XHJcbiAgICAgICAgICAgICAgICBlZGl0b3IuaW5zZXJ0KCc8YSBocmVmPVwiJyArIGFzc2V0LnJlc291cmNlICsgJ1wiIHRpdGxlPVwiJyArIGFzc2V0LmFsdGVybmF0ZVRleHQgKyAnXCIgY2xhc3M9XCJcIiAvPlxcbicpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBlZGl0b3IuaW5zZXJ0KGFzc2V0LnJlc291cmNlKTsgICAgICAgIFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogSW5zZXJ0cyBhbiBpbWFnZSBhdCB0aGUgY3VycmVudCBjdXJzb3IgcG9zaXRpb24uXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIGluc2VydEltYWdlID0gZnVuY3Rpb24gKGltYWdlKSB7XHJcbiAgICAgICAgICAgIHZhciBjdXJzb3JQb3NpdGlvbiA9IGVkaXRvci5zZWxlY3Rpb24uZ2V0UmFuZ2UoKS5zdGFydCxcclxuICAgICAgICAgICAgICAgIGxpbmUgPSBlZGl0b3Iuc2Vzc2lvbi5nZXRMaW5lKGN1cnNvclBvc2l0aW9uLnJvdyk7XHJcblxyXG4gICAgICAgICAgICAvLyBpbnNlcnRpbmcgbWVkaWEgVVJMIGJldHdlZW4gdHdvIHF1b3Rlc1xyXG4gICAgICAgICAgICBpZiAobGluZS5zdWJzdHIoY3Vyc29yUG9zaXRpb24uY29sdW1uIC0gNSwgNSkudG9Mb3dlckNhc2UoKSA9PT0gJ3NyYz1cIicpIHtcclxuICAgICAgICAgICAgICAgIGVkaXRvci5pbnNlcnQoaW1hZ2UucmVzb3VyY2UpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBpbnNlcnRpbmcgbWVkaWEgVVJMIHdpdGggcXVvdGVzXHJcbiAgICAgICAgICAgIGlmIChsaW5lLnN1YnN0cihjdXJzb3JQb3NpdGlvbi5jb2x1bW4gLSA0LCA0KS50b0xvd2VyQ2FzZSgpID09PSAnc3JjPScpIHtcclxuICAgICAgICAgICAgICAgIGVkaXRvci5pbnNlcnQoJ1wiJyArIGltYWdlLnJlc291cmNlICsgJ1wiJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIGluc2VydGluZyBtZWRpYSBhcyBhbiBpbmxpbmUgc3R5bGVcclxuICAgICAgICAgICAgaWYgKGxpbmUuc3Vic3RyKGN1cnNvclBvc2l0aW9uLmNvbHVtbiAtIDQsIDQpLnRvTG93ZXJDYXNlKCkgPT09ICd1cmwoJykge1xyXG4gICAgICAgICAgICAgICAgZWRpdG9yLmluc2VydChpbWFnZS5yZXNvdXJjZSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIGVuc3VyZSB0aGF0IHRoZSBjdXJyZW50IGN1cnNvciBwb3NpdGlvbiB3YXJyYW50cyBhIGNvbXBsZXRlIGltZyBIVE1MXHJcbiAgICAgICAgICAgIC8vIHRhZyBpbnN0ZWFkIG9mIHRoZSBVUkwuXHJcbiAgICAgICAgICAgIHZhciBjaGFyYWN0ZXIgPSBsaW5lLnN1YnN0cihjdXJzb3JQb3NpdGlvbi5jb2x1bW4gLSAxLCAxKS50b0xvd2VyQ2FzZSgpXHJcblxyXG4gICAgICAgICAgICBpZiAoY2hhcmFjdGVyID09PSAnPicgfHwgY2hhcmFjdGVyID09PSAnJyB8fCBjaGFyYWN0ZXIgPT09ICcgJykge1xyXG4gICAgICAgICAgICAgICAgZWRpdG9yLmluc2VydCgnPGltZyBzcmM9XCInICsgaW1hZ2UucmVzb3VyY2UgKyAnXCIgYWx0PVwiJyArIGltYWdlLmFsdGVybmF0ZVRleHQgKyAnXCIgY2xhc3M9XCJcIiAvPlxcbicpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBlZGl0b3IuaW5zZXJ0KGltYWdlLnJlc291cmNlKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBVcGRhdGVzIGhpZGRlbiBIVE1MIGlucHV0IHdpdGggbGF0ZXN0IGNvbnRlbnQgZnJvbSBBY2UgZWRpdG9yLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciB1cGRhdGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICRpbnB1dC52YWx1ZSA9IHNlc3Npb24uZ2V0VmFsdWUoKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgdXBkYXRlU2Vzc2lvbiA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgc2Vzc2lvbi5zZXRWYWx1ZSgkaW5wdXQudmFsdWUpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGluaXQoKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEluaXRpYWxpc2VzIGluc3RhbmNlcyBvZiB0aGUgQWNlIGVkaXRvci5cclxuICAgICAqL1xyXG4gICAgdmFyIGluaXRpYWxpc2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgdmFyICRlZGl0b3JzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmpzLWVkaXRvcicpO1xyXG5cclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8ICRlZGl0b3JzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGVkaXRvckluc3RhbmNlKCRlZGl0b3JzW2ldKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBpbml0aWFsaXNlKTtcclxufSkoKTsiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
