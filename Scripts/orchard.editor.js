/*
** NOTE: This file is generated by Gulp and should not be edited directly!
** Any changes made directly to this file will be overwritten next time its asset group is processed by Gulp.
*/

(function () {
    var editorInstance = function ($el) {
        var editor, session, $input;

        /**
         * Add provided media to editor, dictated by current ace editor selection state.
         */
        var addMedia = function (e) {
            if (!e || !e.detail || !e.detail.mediaItems) {
                return;
            }

            var alt, cursorPosition, line, url;

            for (var i = 0; i < e.detail.mediaItems.length; i++) {
                switch (e.detail.mediaItems[i].contentType.toLowerCase()) {
                    case 'document':
                        insertDocument(e.detail.mediaItems[i]);
                        break;
                    case 'image':
                        insertImage(e.detail.mediaItems[i]);
                        break;
                }
            }
        };

        /**
         * Filters out unwanted annotations (e.g. warning about doctype) due to common
         * case is the HTML being edited is not a full HTML document but a piece of HTML.
         */
        var filterAnnotation = function () {
            var annotations = session.getAnnotations() || [], i = len = annotations.length;

            while (i--) {
                if (/doctype first\. Expected/.test(annotations[i].text)) {
                    annotations.splice(i, 1);
                }
            }

            if (len > annotations.length) {
                session.setAnnotations(annotations);
            }
        };

        /**
         * Returns textarea that needs to get turned into Ace editor.
         */
        var getTextArea = function () {
            return $el.querySelector('.js-editor-code > textarea');
        };

        /**
         * Initialises Ace editor.
         */
        var init = function () {
            editor = ace.edit(getTextArea().id);
            session = editor.getSession();

            $input = $el.querySelector('.editor-input');

            editor.setTheme('ace/theme/monokai');
            editor.setShowPrintMargin(false);
            editor.$blockScrolling = Infinity;

            session.setMode('ace/mode/html');
            session.setUseWrapMode(true);

            session.on('changeAnnotation', filterAnnotation);
            session.on('change', update);

            $input.addEventListener('change', updateSession);
            $el.addEventListener('editor:valueUpdate', updateSession);
            $el.addEventListener('editor:addMedia', addMedia);
        };

        /**
         * Inserts hyperlink for document.
         */
        var insertDocument = function(asset) {
            var cursorPosition = editor.selection.getRange().start,
                line = editor.session.getLine(cursorPosition.row);

            // inserting media URL between two quotes
            if (line.substr(cursorPosition.column - 5, 5).toLowerCase() === 'href="') {
                editor.insert(asset.resource);
                return;
            }

            // inserting media URL with quotes
            if (line.substr(cursorPosition.column - 4, 4).toLowerCase() === 'href=') {
                editor.insert('"' + asset.resource + '"');
                return;
            }

            // ensure that the current cursor position warrants a complete anchor HTML
            // tag instead of the URL.
            var character = line.substr(cursorPosition.column - 1, 1).toLowerCase()

            if (character === '>' || character === '' || character === ' ') {
                editor.insert('<a href="' + asset.resource + '" title="' + asset.alternateText + '" class="" />\n');
                return;
            }

            editor.insert(asset.resource);        
        }

        /**
         * Inserts an image at the current cursor position.
         */
        var insertImage = function (image) {
            var cursorPosition = editor.selection.getRange().start,
                line = editor.session.getLine(cursorPosition.row);

            // inserting media URL between two quotes
            if (line.substr(cursorPosition.column - 5, 5).toLowerCase() === 'src="') {
                editor.insert(image.resource);
                return;
            }

            // inserting media URL with quotes
            if (line.substr(cursorPosition.column - 4, 4).toLowerCase() === 'src=') {
                editor.insert('"' + image.resource + '"');
                return;
            }

            // inserting media as an inline style
            if (line.substr(cursorPosition.column - 4, 4).toLowerCase() === 'url(') {
                editor.insert(image.resource);
                return;
            }

            // ensure that the current cursor position warrants a complete img HTML
            // tag instead of the URL.
            var character = line.substr(cursorPosition.column - 1, 1).toLowerCase()

            if (character === '>' || character === '' || character === ' ') {
                editor.insert('<img src="' + image.resource + '" alt="' + image.alternateText + '" class="" />\n');
                return;
            }

            editor.insert(image.resource);
        };

        /**
         * Updates hidden HTML input with latest content from Ace editor.
         */
        var update = function () {
            $input.value = session.getValue();
        };

        var updateSession = function () {
            session.setValue($input.value);
        };

        init();
    }

    /**
     * Initialises instances of the Ace editor.
     */
    var initialise = function () {
        var $editors = document.querySelectorAll('.js-editor');

        for (var i = 0; i < $editors.length; i++) {
            editorInstance($editors[i]);
        }
    };

    document.addEventListener('DOMContentLoaded', initialise);
})();
(function () {
    var CSS_CODE_EDITOR = 'is-code-editor',
        CSS_VISUAL_EDITOR = 'is-visual-editor',
        CSS_FULLSCREEN = 'is-fullscreen',
        KEY_ESC = 27;

    var editorInstance = function ($el) {
        var instanceId, $visualEditor, $visualEditorIFrame, $input, $resizer;

        /**
         * Generates unique ID for instance
         */
        var setId = function () {
            instanceId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
                 return v.toString(16);
            });
        };
        
        /**
         * Returns the type of content
         */
        var getContentType = function () {
            return document.querySelector('.js-editor-content-type').value;
        };

        /**
         * User has clicked an action within the toolbar.
         */
        var handleAction = function (e) {
            var action = e.currentTarget.getAttribute('data-action');

            switch (action) {
                case 'insert-media':
                    openMediaPicker();
                    break;
                case 'toggle-code-editor':
                    toggleCodeEditor();
                    break;
                case 'toggle-visual-editor':
                    toggleVisualEditor();
                    break;
                case 'toggle-fullscreen':
                    toggleFullscreen();
                    break;
            }
        }

        /**
         * Initialises Medium editor.
         */
        var init = function () {
            setId();

            $visualEditor = $el.querySelector('.js-editor-visual');
            $input = $el.querySelector('.editor-input');
            $visualEditorIFrame = $el.querySelector('.js-editor-visual-iframe');
            $resizer = $el.querySelector('.js-editor-resizer');

            var $actions = $el.querySelectorAll('.js-toolbar-btn');

            for (var i = 0; i < $actions.length; i++) {
                $actions[i].addEventListener('click', handleAction);
            }

            window.addEventListener('message', onMessage);

            toggleCodeEditor();
            setupResizer();
        };

        /**
         * Received a message from the iframe editor.
         */
        var onMessage = function (e) {
            if (e.data.id !== instanceId) {
                return;
            }
            
            if (e.data.action === 'update') {
                $input.value = html_beautify ? html_beautify(e.data.value, { wrap_line_length: 0 }) : e.data.value;
                $el.dispatchEvent(new Event('editor:valueUpdate'));
            }
        };

        /**
         * Opens media library picker.
         */
        var openMediaPicker = function () {
            var adminIndex = location.href.toLowerCase().indexOf("/admin/"),
                _this = this,
                url;

            if (adminIndex === -1) {
                return;
            }

            url = location.href.substr(0, adminIndex) + "/Admin/Orchard.MediaLibrary?dialog=true";

            $.colorbox({
                href: url,
                iframe: true,
                reposition: true,
                width: '90%',
                height: '90%',
                onLoad: function () {
                    // hide the scrollbars from the main window
                    $('html, body').css('overflow', 'hidden');
                },
                onClosed: function () {
                    var selectedData = $.colorbox.selectedData;

                    $('html, body').css('overflow', '');

                    if (selectedData.length === 0) {
                        return;
                    }
                    
                    $el.dispatchEvent(new CustomEvent('editor:addMedia', {
                        detail: {
                            mediaItems: selectedData
                        }
                    }));
                }
            });
        };

        var setupResizer = function () {
            var initialY, initialHeight;

            var dispose = function () {
                window.removeEventListener('mousemove', onDrag);
                window.removeEventListener('mouseup', dispose);
                $visualEditorIFrame.contentWindow.removeEventListener('mousemove', onIFrameDrag);
                $visualEditorIFrame.contentWindow.removeEventListener('mouseup', dispose);
            };

            var onDrag = function (e) {
                $el.style.height = (initialHeight + (e.clientY - initialY)) + 'px';
            };

            var onIFrameDrag = function (e) {
                var boundingClientRect = $visualEditorIFrame.getBoundingClientRect(),
                    evt = new CustomEvent('mousemove', { bubbles: true, cancelable: false });

                evt.clientX = e.clientX + boundingClientRect.left;
                evt.clientY = e.clientY + boundingClientRect.top;

                $visualEditorIFrame.dispatchEvent(evt);
            };

            $resizer.addEventListener('mousedown', function (e) {
                initialY = e.clientY;
                initialHeight = $el.offsetHeight;

                window.addEventListener('mousemove', onDrag);
                window.addEventListener('mouseup', dispose);
                $visualEditorIFrame.contentWindow.addEventListener('mousemove', onIFrameDrag);
                $visualEditorIFrame.contentWindow.addEventListener('mouseup', dispose);
            })
        };

        /**
         * Displays code editor.
         */
        var toggleCodeEditor = function () {
            $el.classList.remove(CSS_VISUAL_EDITOR);
            $el.classList.add(CSS_CODE_EDITOR);

            $el.dispatchEvent(new Event('editor:valueUpdate'));
        };

        /**
         * Toggles fullscreen state.
         */
        var toggleFullscreen = function (e) {
            if (e && e.keyCode !== KEY_ESC) {
                return;
            }

            if ($el.classList.contains(CSS_FULLSCREEN)) {
                $el.classList.remove(CSS_FULLSCREEN);

                document.querySelector('html').style.overflow = '';
                window.removeEventListener('keydown', toggleFullscreen);
                return;
            }

            $el.classList.add(CSS_FULLSCREEN);
            document.querySelector('html').style.overflow = 'hidden';

            window.addEventListener('keydown', toggleFullscreen);
        };

        /**
         * Displays visual editor.
         */
        var toggleVisualEditor = function () {
            // send information to iframe.
            sendMessage({
                action: 'update',
                value: $input.value,
                mediaPath: getContentType()
            });

            $el.classList.remove(CSS_CODE_EDITOR);
            $el.classList.add(CSS_VISUAL_EDITOR);
        };

        /**
         * Sends a message to the iframe.
         */
        var sendMessage = function (msg) {
            msg.instanceId = instanceId;
            $visualEditorIFrame.contentWindow.postMessage(JSON.stringify(msg), '*');
        };

        init();
    }

    /**
     * Initialises instances of the Ace editor.
     */
    var initialise = function () {
        var $editors = document.querySelectorAll('.js-editor');

        for (var i = 0; i < $editors.length; i++) {
            editorInstance($editors[i]);
        }
    };

    document.addEventListener('DOMContentLoaded', initialise);
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9yY2hhcmQuZWRpdG9yLmpzIiwib3JjaGFyZC5hY2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEFDTEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBRHpLQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6Im9yY2hhcmQuZWRpdG9yLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBDU1NfQ09ERV9FRElUT1IgPSAnaXMtY29kZS1lZGl0b3InLFxyXG4gICAgICAgIENTU19WSVNVQUxfRURJVE9SID0gJ2lzLXZpc3VhbC1lZGl0b3InLFxyXG4gICAgICAgIENTU19GVUxMU0NSRUVOID0gJ2lzLWZ1bGxzY3JlZW4nLFxyXG4gICAgICAgIEtFWV9FU0MgPSAyNztcclxuXHJcbiAgICB2YXIgZWRpdG9ySW5zdGFuY2UgPSBmdW5jdGlvbiAoJGVsKSB7XHJcbiAgICAgICAgdmFyIGluc3RhbmNlSWQsICR2aXN1YWxFZGl0b3IsICR2aXN1YWxFZGl0b3JJRnJhbWUsICRpbnB1dCwgJHJlc2l6ZXI7XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIEdlbmVyYXRlcyB1bmlxdWUgSUQgZm9yIGluc3RhbmNlXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIHNldElkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpbnN0YW5jZUlkID0gJ3h4eHh4eHh4LXh4eHgtNHh4eC15eHh4LXh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3h5XS9nLCBmdW5jdGlvbihjKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgciA9IE1hdGgucmFuZG9tKCkqMTZ8MCwgdiA9IGMgPT0gJ3gnID8gciA6IChyJjB4M3wweDgpO1xyXG4gICAgICAgICAgICAgICAgIHJldHVybiB2LnRvU3RyaW5nKDE2KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBSZXR1cm5zIHRoZSB0eXBlIG9mIGNvbnRlbnRcclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgZ2V0Q29udGVudFR5cGUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuanMtZWRpdG9yLWNvbnRlbnQtdHlwZScpLnZhbHVlO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFVzZXIgaGFzIGNsaWNrZWQgYW4gYWN0aW9uIHdpdGhpbiB0aGUgdG9vbGJhci5cclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgaGFuZGxlQWN0aW9uID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgdmFyIGFjdGlvbiA9IGUuY3VycmVudFRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtYWN0aW9uJyk7XHJcblxyXG4gICAgICAgICAgICBzd2l0Y2ggKGFjdGlvbikge1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnaW5zZXJ0LW1lZGlhJzpcclxuICAgICAgICAgICAgICAgICAgICBvcGVuTWVkaWFQaWNrZXIoKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3RvZ2dsZS1jb2RlLWVkaXRvcic6XHJcbiAgICAgICAgICAgICAgICAgICAgdG9nZ2xlQ29kZUVkaXRvcigpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAndG9nZ2xlLXZpc3VhbC1lZGl0b3InOlxyXG4gICAgICAgICAgICAgICAgICAgIHRvZ2dsZVZpc3VhbEVkaXRvcigpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAndG9nZ2xlLWZ1bGxzY3JlZW4nOlxyXG4gICAgICAgICAgICAgICAgICAgIHRvZ2dsZUZ1bGxzY3JlZW4oKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogSW5pdGlhbGlzZXMgTWVkaXVtIGVkaXRvci5cclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgaW5pdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgc2V0SWQoKTtcclxuXHJcbiAgICAgICAgICAgICR2aXN1YWxFZGl0b3IgPSAkZWwucXVlcnlTZWxlY3RvcignLmpzLWVkaXRvci12aXN1YWwnKTtcclxuICAgICAgICAgICAgJGlucHV0ID0gJGVsLnF1ZXJ5U2VsZWN0b3IoJy5lZGl0b3ItaW5wdXQnKTtcclxuICAgICAgICAgICAgJHZpc3VhbEVkaXRvcklGcmFtZSA9ICRlbC5xdWVyeVNlbGVjdG9yKCcuanMtZWRpdG9yLXZpc3VhbC1pZnJhbWUnKTtcclxuICAgICAgICAgICAgJHJlc2l6ZXIgPSAkZWwucXVlcnlTZWxlY3RvcignLmpzLWVkaXRvci1yZXNpemVyJyk7XHJcblxyXG4gICAgICAgICAgICB2YXIgJGFjdGlvbnMgPSAkZWwucXVlcnlTZWxlY3RvckFsbCgnLmpzLXRvb2xiYXItYnRuJyk7XHJcblxyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8ICRhY3Rpb25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAkYWN0aW9uc1tpXS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZUFjdGlvbik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgb25NZXNzYWdlKTtcclxuXHJcbiAgICAgICAgICAgIHRvZ2dsZUNvZGVFZGl0b3IoKTtcclxuICAgICAgICAgICAgc2V0dXBSZXNpemVyKCk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogUmVjZWl2ZWQgYSBtZXNzYWdlIGZyb20gdGhlIGlmcmFtZSBlZGl0b3IuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIG9uTWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgIGlmIChlLmRhdGEuaWQgIT09IGluc3RhbmNlSWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKGUuZGF0YS5hY3Rpb24gPT09ICd1cGRhdGUnKSB7XHJcbiAgICAgICAgICAgICAgICAkaW5wdXQudmFsdWUgPSBodG1sX2JlYXV0aWZ5ID8gaHRtbF9iZWF1dGlmeShlLmRhdGEudmFsdWUsIHsgd3JhcF9saW5lX2xlbmd0aDogMCB9KSA6IGUuZGF0YS52YWx1ZTtcclxuICAgICAgICAgICAgICAgICRlbC5kaXNwYXRjaEV2ZW50KG5ldyBFdmVudCgnZWRpdG9yOnZhbHVlVXBkYXRlJykpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogT3BlbnMgbWVkaWEgbGlicmFyeSBwaWNrZXIuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIG9wZW5NZWRpYVBpY2tlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGFkbWluSW5kZXggPSBsb2NhdGlvbi5ocmVmLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihcIi9hZG1pbi9cIiksXHJcbiAgICAgICAgICAgICAgICBfdGhpcyA9IHRoaXMsXHJcbiAgICAgICAgICAgICAgICB1cmw7XHJcblxyXG4gICAgICAgICAgICBpZiAoYWRtaW5JbmRleCA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdXJsID0gbG9jYXRpb24uaHJlZi5zdWJzdHIoMCwgYWRtaW5JbmRleCkgKyBcIi9BZG1pbi9PcmNoYXJkLk1lZGlhTGlicmFyeT9kaWFsb2c9dHJ1ZVwiO1xyXG5cclxuICAgICAgICAgICAgJC5jb2xvcmJveCh7XHJcbiAgICAgICAgICAgICAgICBocmVmOiB1cmwsXHJcbiAgICAgICAgICAgICAgICBpZnJhbWU6IHRydWUsXHJcbiAgICAgICAgICAgICAgICByZXBvc2l0aW9uOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgd2lkdGg6ICc5MCUnLFxyXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiAnOTAlJyxcclxuICAgICAgICAgICAgICAgIG9uTG9hZDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGhpZGUgdGhlIHNjcm9sbGJhcnMgZnJvbSB0aGUgbWFpbiB3aW5kb3dcclxuICAgICAgICAgICAgICAgICAgICAkKCdodG1sLCBib2R5JykuY3NzKCdvdmVyZmxvdycsICdoaWRkZW4nKTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBvbkNsb3NlZDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzZWxlY3RlZERhdGEgPSAkLmNvbG9yYm94LnNlbGVjdGVkRGF0YTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgJCgnaHRtbCwgYm9keScpLmNzcygnb3ZlcmZsb3cnLCAnJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZERhdGEubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgJGVsLmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCdlZGl0b3I6YWRkTWVkaWEnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRldGFpbDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFJdGVtczogc2VsZWN0ZWREYXRhXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBzZXR1cFJlc2l6ZXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBpbml0aWFsWSwgaW5pdGlhbEhlaWdodDtcclxuXHJcbiAgICAgICAgICAgIHZhciBkaXNwb3NlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG9uRHJhZyk7XHJcbiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGRpc3Bvc2UpO1xyXG4gICAgICAgICAgICAgICAgJHZpc3VhbEVkaXRvcklGcmFtZS5jb250ZW50V2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG9uSUZyYW1lRHJhZyk7XHJcbiAgICAgICAgICAgICAgICAkdmlzdWFsRWRpdG9ySUZyYW1lLmNvbnRlbnRXaW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGRpc3Bvc2UpO1xyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgdmFyIG9uRHJhZyA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgICAgICAkZWwuc3R5bGUuaGVpZ2h0ID0gKGluaXRpYWxIZWlnaHQgKyAoZS5jbGllbnRZIC0gaW5pdGlhbFkpKSArICdweCc7XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICB2YXIgb25JRnJhbWVEcmFnID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgIHZhciBib3VuZGluZ0NsaWVudFJlY3QgPSAkdmlzdWFsRWRpdG9ySUZyYW1lLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLFxyXG4gICAgICAgICAgICAgICAgICAgIGV2dCA9IG5ldyBDdXN0b21FdmVudCgnbW91c2Vtb3ZlJywgeyBidWJibGVzOiB0cnVlLCBjYW5jZWxhYmxlOiBmYWxzZSB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICBldnQuY2xpZW50WCA9IGUuY2xpZW50WCArIGJvdW5kaW5nQ2xpZW50UmVjdC5sZWZ0O1xyXG4gICAgICAgICAgICAgICAgZXZ0LmNsaWVudFkgPSBlLmNsaWVudFkgKyBib3VuZGluZ0NsaWVudFJlY3QudG9wO1xyXG5cclxuICAgICAgICAgICAgICAgICR2aXN1YWxFZGl0b3JJRnJhbWUuZGlzcGF0Y2hFdmVudChldnQpO1xyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgJHJlc2l6ZXIuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgIGluaXRpYWxZID0gZS5jbGllbnRZO1xyXG4gICAgICAgICAgICAgICAgaW5pdGlhbEhlaWdodCA9ICRlbC5vZmZzZXRIZWlnaHQ7XHJcblxyXG4gICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG9uRHJhZyk7XHJcbiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGRpc3Bvc2UpO1xyXG4gICAgICAgICAgICAgICAgJHZpc3VhbEVkaXRvcklGcmFtZS5jb250ZW50V2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG9uSUZyYW1lRHJhZyk7XHJcbiAgICAgICAgICAgICAgICAkdmlzdWFsRWRpdG9ySUZyYW1lLmNvbnRlbnRXaW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGRpc3Bvc2UpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIERpc3BsYXlzIGNvZGUgZWRpdG9yLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciB0b2dnbGVDb2RlRWRpdG9yID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAkZWwuY2xhc3NMaXN0LnJlbW92ZShDU1NfVklTVUFMX0VESVRPUik7XHJcbiAgICAgICAgICAgICRlbC5jbGFzc0xpc3QuYWRkKENTU19DT0RFX0VESVRPUik7XHJcblxyXG4gICAgICAgICAgICAkZWwuZGlzcGF0Y2hFdmVudChuZXcgRXZlbnQoJ2VkaXRvcjp2YWx1ZVVwZGF0ZScpKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBUb2dnbGVzIGZ1bGxzY3JlZW4gc3RhdGUuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIHRvZ2dsZUZ1bGxzY3JlZW4gPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICBpZiAoZSAmJiBlLmtleUNvZGUgIT09IEtFWV9FU0MpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKCRlbC5jbGFzc0xpc3QuY29udGFpbnMoQ1NTX0ZVTExTQ1JFRU4pKSB7XHJcbiAgICAgICAgICAgICAgICAkZWwuY2xhc3NMaXN0LnJlbW92ZShDU1NfRlVMTFNDUkVFTik7XHJcblxyXG4gICAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaHRtbCcpLnN0eWxlLm92ZXJmbG93ID0gJyc7XHJcbiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRvZ2dsZUZ1bGxzY3JlZW4pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAkZWwuY2xhc3NMaXN0LmFkZChDU1NfRlVMTFNDUkVFTik7XHJcbiAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2h0bWwnKS5zdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nO1xyXG5cclxuICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0b2dnbGVGdWxsc2NyZWVuKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBEaXNwbGF5cyB2aXN1YWwgZWRpdG9yLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciB0b2dnbGVWaXN1YWxFZGl0b3IgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIC8vIHNlbmQgaW5mb3JtYXRpb24gdG8gaWZyYW1lLlxyXG4gICAgICAgICAgICBzZW5kTWVzc2FnZSh7XHJcbiAgICAgICAgICAgICAgICBhY3Rpb246ICd1cGRhdGUnLFxyXG4gICAgICAgICAgICAgICAgdmFsdWU6ICRpbnB1dC52YWx1ZSxcclxuICAgICAgICAgICAgICAgIG1lZGlhUGF0aDogZ2V0Q29udGVudFR5cGUoKVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICRlbC5jbGFzc0xpc3QucmVtb3ZlKENTU19DT0RFX0VESVRPUik7XHJcbiAgICAgICAgICAgICRlbC5jbGFzc0xpc3QuYWRkKENTU19WSVNVQUxfRURJVE9SKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBTZW5kcyBhIG1lc3NhZ2UgdG8gdGhlIGlmcmFtZS5cclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgc2VuZE1lc3NhZ2UgPSBmdW5jdGlvbiAobXNnKSB7XHJcbiAgICAgICAgICAgIG1zZy5pbnN0YW5jZUlkID0gaW5zdGFuY2VJZDtcclxuICAgICAgICAgICAgJHZpc3VhbEVkaXRvcklGcmFtZS5jb250ZW50V2luZG93LnBvc3RNZXNzYWdlKEpTT04uc3RyaW5naWZ5KG1zZyksICcqJyk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaW5pdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSW5pdGlhbGlzZXMgaW5zdGFuY2VzIG9mIHRoZSBBY2UgZWRpdG9yLlxyXG4gICAgICovXHJcbiAgICB2YXIgaW5pdGlhbGlzZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgJGVkaXRvcnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuanMtZWRpdG9yJyk7XHJcblxyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgJGVkaXRvcnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgZWRpdG9ySW5zdGFuY2UoJGVkaXRvcnNbaV0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGluaXRpYWxpc2UpO1xyXG59KSgpOyIsIihmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgZWRpdG9ySW5zdGFuY2UgPSBmdW5jdGlvbiAoJGVsKSB7XHJcbiAgICAgICAgdmFyIGVkaXRvciwgc2Vzc2lvbiwgJGlucHV0O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBBZGQgcHJvdmlkZWQgbWVkaWEgdG8gZWRpdG9yLCBkaWN0YXRlZCBieSBjdXJyZW50IGFjZSBlZGl0b3Igc2VsZWN0aW9uIHN0YXRlLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciBhZGRNZWRpYSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgIGlmICghZSB8fCAhZS5kZXRhaWwgfHwgIWUuZGV0YWlsLm1lZGlhSXRlbXMpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdmFyIGFsdCwgY3Vyc29yUG9zaXRpb24sIGxpbmUsIHVybDtcclxuXHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZS5kZXRhaWwubWVkaWFJdGVtcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgc3dpdGNoIChlLmRldGFpbC5tZWRpYUl0ZW1zW2ldLmNvbnRlbnRUeXBlLnRvTG93ZXJDYXNlKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdkb2N1bWVudCc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydERvY3VtZW50KGUuZGV0YWlsLm1lZGlhSXRlbXNbaV0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdpbWFnZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydEltYWdlKGUuZGV0YWlsLm1lZGlhSXRlbXNbaV0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIEZpbHRlcnMgb3V0IHVud2FudGVkIGFubm90YXRpb25zIChlLmcuIHdhcm5pbmcgYWJvdXQgZG9jdHlwZSkgZHVlIHRvIGNvbW1vblxyXG4gICAgICAgICAqIGNhc2UgaXMgdGhlIEhUTUwgYmVpbmcgZWRpdGVkIGlzIG5vdCBhIGZ1bGwgSFRNTCBkb2N1bWVudCBidXQgYSBwaWVjZSBvZiBIVE1MLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciBmaWx0ZXJBbm5vdGF0aW9uID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICB2YXIgYW5ub3RhdGlvbnMgPSBzZXNzaW9uLmdldEFubm90YXRpb25zKCkgfHwgW10sIGkgPSBsZW4gPSBhbm5vdGF0aW9ucy5sZW5ndGg7XHJcblxyXG4gICAgICAgICAgICB3aGlsZSAoaS0tKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoL2RvY3R5cGUgZmlyc3RcXC4gRXhwZWN0ZWQvLnRlc3QoYW5ub3RhdGlvbnNbaV0udGV4dCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBhbm5vdGF0aW9ucy5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChsZW4gPiBhbm5vdGF0aW9ucy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHNlc3Npb24uc2V0QW5ub3RhdGlvbnMoYW5ub3RhdGlvbnMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogUmV0dXJucyB0ZXh0YXJlYSB0aGF0IG5lZWRzIHRvIGdldCB0dXJuZWQgaW50byBBY2UgZWRpdG9yLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciBnZXRUZXh0QXJlYSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuICRlbC5xdWVyeVNlbGVjdG9yKCcuanMtZWRpdG9yLWNvZGUgPiB0ZXh0YXJlYScpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIEluaXRpYWxpc2VzIEFjZSBlZGl0b3IuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIGluaXQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGVkaXRvciA9IGFjZS5lZGl0KGdldFRleHRBcmVhKCkuaWQpO1xyXG4gICAgICAgICAgICBzZXNzaW9uID0gZWRpdG9yLmdldFNlc3Npb24oKTtcclxuXHJcbiAgICAgICAgICAgICRpbnB1dCA9ICRlbC5xdWVyeVNlbGVjdG9yKCcuZWRpdG9yLWlucHV0Jyk7XHJcblxyXG4gICAgICAgICAgICBlZGl0b3Iuc2V0VGhlbWUoJ2FjZS90aGVtZS9tb25va2FpJyk7XHJcbiAgICAgICAgICAgIGVkaXRvci5zZXRTaG93UHJpbnRNYXJnaW4oZmFsc2UpO1xyXG4gICAgICAgICAgICBlZGl0b3IuJGJsb2NrU2Nyb2xsaW5nID0gSW5maW5pdHk7XHJcblxyXG4gICAgICAgICAgICBzZXNzaW9uLnNldE1vZGUoJ2FjZS9tb2RlL2h0bWwnKTtcclxuICAgICAgICAgICAgc2Vzc2lvbi5zZXRVc2VXcmFwTW9kZSh0cnVlKTtcclxuXHJcbiAgICAgICAgICAgIHNlc3Npb24ub24oJ2NoYW5nZUFubm90YXRpb24nLCBmaWx0ZXJBbm5vdGF0aW9uKTtcclxuICAgICAgICAgICAgc2Vzc2lvbi5vbignY2hhbmdlJywgdXBkYXRlKTtcclxuXHJcbiAgICAgICAgICAgICRpbnB1dC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCB1cGRhdGVTZXNzaW9uKTtcclxuICAgICAgICAgICAgJGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2VkaXRvcjp2YWx1ZVVwZGF0ZScsIHVwZGF0ZVNlc3Npb24pO1xyXG4gICAgICAgICAgICAkZWwuYWRkRXZlbnRMaXN0ZW5lcignZWRpdG9yOmFkZE1lZGlhJywgYWRkTWVkaWEpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIEluc2VydHMgaHlwZXJsaW5rIGZvciBkb2N1bWVudC5cclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgaW5zZXJ0RG9jdW1lbnQgPSBmdW5jdGlvbihhc3NldCkge1xyXG4gICAgICAgICAgICB2YXIgY3Vyc29yUG9zaXRpb24gPSBlZGl0b3Iuc2VsZWN0aW9uLmdldFJhbmdlKCkuc3RhcnQsXHJcbiAgICAgICAgICAgICAgICBsaW5lID0gZWRpdG9yLnNlc3Npb24uZ2V0TGluZShjdXJzb3JQb3NpdGlvbi5yb3cpO1xyXG5cclxuICAgICAgICAgICAgLy8gaW5zZXJ0aW5nIG1lZGlhIFVSTCBiZXR3ZWVuIHR3byBxdW90ZXNcclxuICAgICAgICAgICAgaWYgKGxpbmUuc3Vic3RyKGN1cnNvclBvc2l0aW9uLmNvbHVtbiAtIDUsIDUpLnRvTG93ZXJDYXNlKCkgPT09ICdocmVmPVwiJykge1xyXG4gICAgICAgICAgICAgICAgZWRpdG9yLmluc2VydChhc3NldC5yZXNvdXJjZSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIGluc2VydGluZyBtZWRpYSBVUkwgd2l0aCBxdW90ZXNcclxuICAgICAgICAgICAgaWYgKGxpbmUuc3Vic3RyKGN1cnNvclBvc2l0aW9uLmNvbHVtbiAtIDQsIDQpLnRvTG93ZXJDYXNlKCkgPT09ICdocmVmPScpIHtcclxuICAgICAgICAgICAgICAgIGVkaXRvci5pbnNlcnQoJ1wiJyArIGFzc2V0LnJlc291cmNlICsgJ1wiJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIGVuc3VyZSB0aGF0IHRoZSBjdXJyZW50IGN1cnNvciBwb3NpdGlvbiB3YXJyYW50cyBhIGNvbXBsZXRlIGFuY2hvciBIVE1MXHJcbiAgICAgICAgICAgIC8vIHRhZyBpbnN0ZWFkIG9mIHRoZSBVUkwuXHJcbiAgICAgICAgICAgIHZhciBjaGFyYWN0ZXIgPSBsaW5lLnN1YnN0cihjdXJzb3JQb3NpdGlvbi5jb2x1bW4gLSAxLCAxKS50b0xvd2VyQ2FzZSgpXHJcblxyXG4gICAgICAgICAgICBpZiAoY2hhcmFjdGVyID09PSAnPicgfHwgY2hhcmFjdGVyID09PSAnJyB8fCBjaGFyYWN0ZXIgPT09ICcgJykge1xyXG4gICAgICAgICAgICAgICAgZWRpdG9yLmluc2VydCgnPGEgaHJlZj1cIicgKyBhc3NldC5yZXNvdXJjZSArICdcIiB0aXRsZT1cIicgKyBhc3NldC5hbHRlcm5hdGVUZXh0ICsgJ1wiIGNsYXNzPVwiXCIgLz5cXG4nKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZWRpdG9yLmluc2VydChhc3NldC5yZXNvdXJjZSk7ICAgICAgICBcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIEluc2VydHMgYW4gaW1hZ2UgYXQgdGhlIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciBpbnNlcnRJbWFnZSA9IGZ1bmN0aW9uIChpbWFnZSkge1xyXG4gICAgICAgICAgICB2YXIgY3Vyc29yUG9zaXRpb24gPSBlZGl0b3Iuc2VsZWN0aW9uLmdldFJhbmdlKCkuc3RhcnQsXHJcbiAgICAgICAgICAgICAgICBsaW5lID0gZWRpdG9yLnNlc3Npb24uZ2V0TGluZShjdXJzb3JQb3NpdGlvbi5yb3cpO1xyXG5cclxuICAgICAgICAgICAgLy8gaW5zZXJ0aW5nIG1lZGlhIFVSTCBiZXR3ZWVuIHR3byBxdW90ZXNcclxuICAgICAgICAgICAgaWYgKGxpbmUuc3Vic3RyKGN1cnNvclBvc2l0aW9uLmNvbHVtbiAtIDUsIDUpLnRvTG93ZXJDYXNlKCkgPT09ICdzcmM9XCInKSB7XHJcbiAgICAgICAgICAgICAgICBlZGl0b3IuaW5zZXJ0KGltYWdlLnJlc291cmNlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gaW5zZXJ0aW5nIG1lZGlhIFVSTCB3aXRoIHF1b3Rlc1xyXG4gICAgICAgICAgICBpZiAobGluZS5zdWJzdHIoY3Vyc29yUG9zaXRpb24uY29sdW1uIC0gNCwgNCkudG9Mb3dlckNhc2UoKSA9PT0gJ3NyYz0nKSB7XHJcbiAgICAgICAgICAgICAgICBlZGl0b3IuaW5zZXJ0KCdcIicgKyBpbWFnZS5yZXNvdXJjZSArICdcIicpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBpbnNlcnRpbmcgbWVkaWEgYXMgYW4gaW5saW5lIHN0eWxlXHJcbiAgICAgICAgICAgIGlmIChsaW5lLnN1YnN0cihjdXJzb3JQb3NpdGlvbi5jb2x1bW4gLSA0LCA0KS50b0xvd2VyQ2FzZSgpID09PSAndXJsKCcpIHtcclxuICAgICAgICAgICAgICAgIGVkaXRvci5pbnNlcnQoaW1hZ2UucmVzb3VyY2UpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBlbnN1cmUgdGhhdCB0aGUgY3VycmVudCBjdXJzb3IgcG9zaXRpb24gd2FycmFudHMgYSBjb21wbGV0ZSBpbWcgSFRNTFxyXG4gICAgICAgICAgICAvLyB0YWcgaW5zdGVhZCBvZiB0aGUgVVJMLlxyXG4gICAgICAgICAgICB2YXIgY2hhcmFjdGVyID0gbGluZS5zdWJzdHIoY3Vyc29yUG9zaXRpb24uY29sdW1uIC0gMSwgMSkudG9Mb3dlckNhc2UoKVxyXG5cclxuICAgICAgICAgICAgaWYgKGNoYXJhY3RlciA9PT0gJz4nIHx8IGNoYXJhY3RlciA9PT0gJycgfHwgY2hhcmFjdGVyID09PSAnICcpIHtcclxuICAgICAgICAgICAgICAgIGVkaXRvci5pbnNlcnQoJzxpbWcgc3JjPVwiJyArIGltYWdlLnJlc291cmNlICsgJ1wiIGFsdD1cIicgKyBpbWFnZS5hbHRlcm5hdGVUZXh0ICsgJ1wiIGNsYXNzPVwiXCIgLz5cXG4nKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZWRpdG9yLmluc2VydChpbWFnZS5yZXNvdXJjZSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogVXBkYXRlcyBoaWRkZW4gSFRNTCBpbnB1dCB3aXRoIGxhdGVzdCBjb250ZW50IGZyb20gQWNlIGVkaXRvci5cclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgdXBkYXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAkaW5wdXQudmFsdWUgPSBzZXNzaW9uLmdldFZhbHVlKCk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIHVwZGF0ZVNlc3Npb24gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHNlc3Npb24uc2V0VmFsdWUoJGlucHV0LnZhbHVlKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpbml0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBJbml0aWFsaXNlcyBpbnN0YW5jZXMgb2YgdGhlIEFjZSBlZGl0b3IuXHJcbiAgICAgKi9cclxuICAgIHZhciBpbml0aWFsaXNlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciAkZWRpdG9ycyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5qcy1lZGl0b3InKTtcclxuXHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAkZWRpdG9ycy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBlZGl0b3JJbnN0YW5jZSgkZWRpdG9yc1tpXSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgaW5pdGlhbGlzZSk7XHJcbn0pKCk7Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
