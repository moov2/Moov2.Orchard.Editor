/*
** NOTE: This file is generated by Gulp and should not be edited directly!
** Any changes made directly to this file will be overwritten next time its asset group is processed by Gulp.
*/

window.Editor = window.Editor || {
    plugins: [],
    instances: []
};
/**
 * Switches editor between fullscreen and normal.
 */

window.Editor.plugins.push({
    action: 'toggle-fullscreen',
    init: false,
    exec: function (instance) {
        var CSS_FULLSCREEN = 'is-fullscreen',
            KEY_ESC = 27;

        var toggleFullscreen = function (e) {
            if (e && e.keyCode !== KEY_ESC) {
                return;
            }
    
            if (instance.$el.classList.contains(CSS_FULLSCREEN)) {
                instance.$el.classList.remove(CSS_FULLSCREEN);
    
                document.querySelector('html').style.overflow = '';
                window.removeEventListener('keydown', toggleFullscreen);
                return;
            }
    
            instance.$el.classList.add(CSS_FULLSCREEN);
            document.querySelector('html').style.overflow = 'hidden';
    
            window.addEventListener('keydown', toggleFullscreen);
        };

        toggleFullscreen();
    }
});
/**
 * Inserts media into the editor from the Orchard media library.
 */

window.Editor.plugins.push({
    action: 'insert-media',
    init: false,
    exec: function (instance) {
        var adminIndex = location.href.toLowerCase().indexOf("/admin/"),
            cachedScrollPosition = 0;

        if (adminIndex === -1) {
            return;
        }

        $.colorbox({
            href: location.href.substr(0, adminIndex) + "/Admin/Orchard.MediaLibrary?dialog=true",
            iframe: true,
            reposition: true,
            width: '90%',
            height: '90%',
            onLoad: function () {
                cachedScrollPosition = $('html').scrollTop();
                // hide the scrollbars from the main window
                $('html, body').css('overflow', 'hidden');
            },
            onClosed: function () {
                var selectedData = $.colorbox.selectedData;

                $('html, body').css('overflow', '');
                $('html').scrollTop(cachedScrollPosition);

                if (selectedData.length === 0) {
                    return;
                }
                
                instance.$el.dispatchEvent(new CustomEvent('editor:addMedia', {
                    detail: {
                        mediaItems: selectedData
                    }
                }));
            }
        });
    }
});
/**
 * Editor can be resized to custom height.
 */

window.Editor.plugins.push({
    action: 'resize',
    init: true,
    exec: function (instance) {
        var initialY, initialHeight,
            $resizer = instance.$el.querySelector('.js-editor-resizer');
        
        var dispose = function () {
            window.removeEventListener('mousemove', onDrag);
            window.removeEventListener('mouseup', dispose);
            instance.$visualIFrame.contentWindow.removeEventListener('mousemove', onIFrameDrag);
            instance.$visualIFrame.contentWindow.removeEventListener('mouseup', dispose);
        };

        var onDrag = function (e) {
            instance.$el.style.height = (initialHeight + (e.clientY - initialY)) + 'px';
        };

        var onIFrameDrag = function (e) {
            var boundingClientRect = instance.$visualIFrame.getBoundingClientRect(),
                evt = new CustomEvent('mousemove', { bubbles: true, cancelable: false });

            evt.clientX = e.clientX + boundingClientRect.left;
            evt.clientY = e.clientY + boundingClientRect.top;

            instance.$visualIFrame.dispatchEvent(evt);
        };

        $resizer.addEventListener('mousedown', function (e) {
            initialY = e.clientY;
            initialHeight = instance.$el.offsetHeight;

            window.addEventListener('mousemove', onDrag);
            window.addEventListener('mouseup', dispose);
            instance.$visualIFrame.contentWindow.addEventListener('mousemove', onIFrameDrag);
            instance.$visualIFrame.contentWindow.addEventListener('mouseup', dispose);
        });
    }
});
(function () {
    var editorInstance = function ($el) {
        var editor, session, $input;

        /**
         * Add provided media to editor, dictated by current ace editor selection state.
         */
        var addMedia = function (e) {
            if (!e || !e.detail || !e.detail.mediaItems) {
                return;
            }

            var alt, cursorPosition, line, url;

            for (var i = 0; i < e.detail.mediaItems.length; i++) {
                switch (e.detail.mediaItems[i].contentType.toLowerCase()) {
                    case 'document':
                        insertDocument(e.detail.mediaItems[i]);
                        break;
                    case 'image':
                        insertImage(e.detail.mediaItems[i]);
                        break;
                }
            }
        };

        /**
         * Filters out unwanted annotations (e.g. warning about doctype) due to common
         * case is the HTML being edited is not a full HTML document but a piece of HTML.
         */
        var filterAnnotation = function () {
            var annotations = session.getAnnotations() || [], i = len = annotations.length;

            while (i--) {
                if (/doctype first\. Expected/.test(annotations[i].text)) {
                    annotations.splice(i, 1);
                }
            }

            if (len > annotations.length) {
                session.setAnnotations(annotations);
            }
        };

        /**
         * Returns textarea that needs to get turned into Ace editor.
         */
        var getTextArea = function () {
            return $el.querySelector('.js-editor-code > textarea');
        };

        /**
         * Initialises Ace editor.
         */
        var init = function () {
            editor = ace.edit(getTextArea().id);
            session = editor.getSession();

            $input = $el.querySelector('.editor-input');

            editor.setTheme('ace/theme/monokai');
            editor.setShowPrintMargin(false);
            editor.$blockScrolling = Infinity;

            session.setMode('ace/mode/html');
            session.setUseWrapMode(true);

            session.on('changeAnnotation', filterAnnotation);
            session.on('change', update);

            $input.addEventListener('change', updateSession);
            $el.addEventListener('editor:valueUpdate', updateSession);
            $el.addEventListener('editor:addMedia', addMedia);
        };

        /**
         * Inserts hyperlink for document.
         */
        var insertDocument = function(asset) {
            var cursorPosition = editor.selection.getRange().start,
                line = editor.session.getLine(cursorPosition.row);

            // inserting media URL between two quotes
            if (line.substr(cursorPosition.column - 5, 5).toLowerCase() === 'href="') {
                editor.insert(asset.resource);
                return;
            }

            // inserting media URL with quotes
            if (line.substr(cursorPosition.column - 4, 4).toLowerCase() === 'href=') {
                editor.insert('"' + asset.resource + '"');
                return;
            }

            // ensure that the current cursor position warrants a complete anchor HTML
            // tag instead of the URL.
            var character = line.substr(cursorPosition.column - 1, 1).toLowerCase()

            if (character === '>' || character === '' || character === ' ') {
                editor.insert('<a href="' + asset.resource + '" title="' + asset.alternateText + '" class="" />\n');
                return;
            }

            editor.insert(asset.resource);        
        }

        /**
         * Inserts an image at the current cursor position.
         */
        var insertImage = function (image) {
            var cursorPosition = editor.selection.getRange().start,
                line = editor.session.getLine(cursorPosition.row);

            // inserting media URL between two quotes
            if (line.substr(cursorPosition.column - 5, 5).toLowerCase() === 'src="') {
                editor.insert(image.resource);
                return;
            }

            // inserting media URL with quotes
            if (line.substr(cursorPosition.column - 4, 4).toLowerCase() === 'src=') {
                editor.insert('"' + image.resource + '"');
                return;
            }

            // inserting media as an inline style
            if (line.substr(cursorPosition.column - 4, 4).toLowerCase() === 'url(') {
                editor.insert(image.resource);
                return;
            }

            // ensure that the current cursor position warrants a complete img HTML
            // tag instead of the URL.
            var character = line.substr(cursorPosition.column - 1, 1).toLowerCase()

            if (character === '>' || character === '' || character === ' ') {
                editor.insert('<img src="' + image.resource + '" alt="' + image.alternateText + '" class="" />\n');
                return;
            }

            editor.insert(image.resource);
        };

        /**
         * Updates hidden HTML input with latest content from Ace editor.
         */
        var update = function () {
            $input.value = session.getValue();
        };

        var updateSession = function () {
            session.setValue($input.value);
        };

        init();
    }

    /**
     * Initialises instances of the Ace editor.
     */
    var initialise = function () {
        var $editors = document.querySelectorAll('.js-editor');

        for (var i = 0; i < $editors.length; i++) {
            editorInstance($editors[i]);
        }
    };

    document.addEventListener('DOMContentLoaded', initialise);
})();
(function () {
    var CSS_CODE_EDITOR = 'is-code-editor',
        CSS_VISUAL_EDITOR = 'is-visual-editor';

    var editorInstance = function ($el) {
        var instanceId = $el.getAttribute('data-id'),
            $visualEditor, $visualEditorIFrame, $input, $resizer;
        
        /**
         * Returns the type of content
         */
        var getContentType = function () {
            return document.querySelector('.js-editor-content-type').value;
        };

        /**
         * Returns object representing instance.
         */
        var getInstance = function () {
            return {
                id: instanceId,
                $el: $el,
                $visualIFrame: $visualEditorIFrame
            };
        }

        /**
         * User has clicked an action within the toolbar.
         */
        var handleAction = function (e) {
            var action = e.currentTarget.getAttribute('data-action'),
                plugins = window.Editor.plugins;

            for (var i = 0; i < plugins.length; i++) {
                if (plugins[i].action === action) {
                    plugins[i].exec(getInstance());
                    return;
                }
            }

            switch (action) {
                case 'toggle-code-editor':
                    toggleCodeEditor();
                    break;
                case 'toggle-visual-editor':
                    toggleVisualEditor();
                    break;
            }
        }

        /**
         * Initialises Medium editor.
         */
        var init = function () {
            $visualEditor = $el.querySelector('.js-editor-visual');
            $input = $el.querySelector('.editor-input');
            $visualEditorIFrame = $el.querySelector('.js-editor-visual-iframe');

            var $actions = $el.querySelectorAll('.js-toolbar-btn');

            for (var i = 0; i < $actions.length; i++) {
                $actions[i].addEventListener('click', handleAction);
            }

            window.addEventListener('message', onMessage);

            toggleCodeEditor();

            // loop over plugins and execute any that are flagged to
            // exec on initialise.
            for (var i = 0; i < window.Editor.plugins.length; i++) {
                if (window.Editor.plugins[i].init) {
                    window.Editor.plugins[i].exec(getInstance());
                }
            }
        };

        /**
         * Received a message from the iframe editor.
         */
        var onMessage = function (e) {
            if (e.data.id !== instanceId) {
                return;
            }

            if (e.data.action === 'update') {
                $input.value = html_beautify ? html_beautify(e.data.value, { wrap_line_length: 0 }) : e.data.value;
                $el.dispatchEvent(new Event('editor:valueUpdate'));
            }
        };

        /**
         * Displays code editor.
         */
        var toggleCodeEditor = function () {
            $el.classList.remove(CSS_VISUAL_EDITOR);
            $el.classList.add(CSS_CODE_EDITOR);

            $el.dispatchEvent(new Event('editor:valueUpdate'));
        };

        /**
         * Displays visual editor.
         */
        var toggleVisualEditor = function () {
            // send information to iframe.
            sendMessage({
                action: 'update',
                value: $input.value,
                mediaPath: getContentType()
            });

            $el.classList.remove(CSS_CODE_EDITOR);
            $el.classList.add(CSS_VISUAL_EDITOR);
        };

        /**
         * Sends a message to the iframe.
         */
        var sendMessage = function (msg) {
            msg.instanceId = instanceId;
            $visualEditorIFrame.contentWindow.postMessage(JSON.stringify(msg), '*');
        };

        init();
    }

    /**
     * Initialises instances of the Ace editor.
     */
    var initialise = function () {
        var $editors = document.querySelectorAll('.js-editor');

        for (var i = 0; i < $editors.length; i++) {
            editorInstance($editors[i]);
        }
    };

    document.addEventListener('DOMContentLoaded', initialise);
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9yY2hhcmQuZWRpdG9yLmpzIiwiZWRpdG9yLmZ1bGxzY3JlZW4uanMiLCJlZGl0b3IuaW5zZXJ0TWVkaWEuanMiLCJlZGl0b3IucmVzaXplci5qcyIsIm9yY2hhcmQuYWNlLmpzIiwib3JjaGFyZC5lZGl0b3IuaW5zdGFuY2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEFBTEE7QUFDQTtBQUNBO0FBQ0E7QUNIQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDNUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDMUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN6S0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJvcmNoYXJkLmVkaXRvci5qcyIsInNvdXJjZXNDb250ZW50IjpbIndpbmRvdy5FZGl0b3IgPSB3aW5kb3cuRWRpdG9yIHx8IHtcclxuICAgIHBsdWdpbnM6IFtdLFxyXG4gICAgaW5zdGFuY2VzOiBbXVxyXG59OyIsIi8qKlxyXG4gKiBTd2l0Y2hlcyBlZGl0b3IgYmV0d2VlbiBmdWxsc2NyZWVuIGFuZCBub3JtYWwuXHJcbiAqL1xyXG5cclxud2luZG93LkVkaXRvci5wbHVnaW5zLnB1c2goe1xyXG4gICAgYWN0aW9uOiAndG9nZ2xlLWZ1bGxzY3JlZW4nLFxyXG4gICAgaW5pdDogZmFsc2UsXHJcbiAgICBleGVjOiBmdW5jdGlvbiAoaW5zdGFuY2UpIHtcclxuICAgICAgICB2YXIgQ1NTX0ZVTExTQ1JFRU4gPSAnaXMtZnVsbHNjcmVlbicsXHJcbiAgICAgICAgICAgIEtFWV9FU0MgPSAyNztcclxuXHJcbiAgICAgICAgdmFyIHRvZ2dsZUZ1bGxzY3JlZW4gPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICBpZiAoZSAmJiBlLmtleUNvZGUgIT09IEtFWV9FU0MpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgXHJcbiAgICAgICAgICAgIGlmIChpbnN0YW5jZS4kZWwuY2xhc3NMaXN0LmNvbnRhaW5zKENTU19GVUxMU0NSRUVOKSkge1xyXG4gICAgICAgICAgICAgICAgaW5zdGFuY2UuJGVsLmNsYXNzTGlzdC5yZW1vdmUoQ1NTX0ZVTExTQ1JFRU4pO1xyXG4gICAgXHJcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdodG1sJykuc3R5bGUub3ZlcmZsb3cgPSAnJztcclxuICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdG9nZ2xlRnVsbHNjcmVlbik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgIFxyXG4gICAgICAgICAgICBpbnN0YW5jZS4kZWwuY2xhc3NMaXN0LmFkZChDU1NfRlVMTFNDUkVFTik7XHJcbiAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2h0bWwnKS5zdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nO1xyXG4gICAgXHJcbiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdG9nZ2xlRnVsbHNjcmVlbik7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdG9nZ2xlRnVsbHNjcmVlbigpO1xyXG4gICAgfVxyXG59KTsiLCIvKipcclxuICogSW5zZXJ0cyBtZWRpYSBpbnRvIHRoZSBlZGl0b3IgZnJvbSB0aGUgT3JjaGFyZCBtZWRpYSBsaWJyYXJ5LlxyXG4gKi9cclxuXHJcbndpbmRvdy5FZGl0b3IucGx1Z2lucy5wdXNoKHtcclxuICAgIGFjdGlvbjogJ2luc2VydC1tZWRpYScsXHJcbiAgICBpbml0OiBmYWxzZSxcclxuICAgIGV4ZWM6IGZ1bmN0aW9uIChpbnN0YW5jZSkge1xyXG4gICAgICAgIHZhciBhZG1pbkluZGV4ID0gbG9jYXRpb24uaHJlZi50b0xvd2VyQ2FzZSgpLmluZGV4T2YoXCIvYWRtaW4vXCIpLFxyXG4gICAgICAgICAgICBjYWNoZWRTY3JvbGxQb3NpdGlvbiA9IDA7XHJcblxyXG4gICAgICAgIGlmIChhZG1pbkluZGV4ID09PSAtMSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAkLmNvbG9yYm94KHtcclxuICAgICAgICAgICAgaHJlZjogbG9jYXRpb24uaHJlZi5zdWJzdHIoMCwgYWRtaW5JbmRleCkgKyBcIi9BZG1pbi9PcmNoYXJkLk1lZGlhTGlicmFyeT9kaWFsb2c9dHJ1ZVwiLFxyXG4gICAgICAgICAgICBpZnJhbWU6IHRydWUsXHJcbiAgICAgICAgICAgIHJlcG9zaXRpb246IHRydWUsXHJcbiAgICAgICAgICAgIHdpZHRoOiAnOTAlJyxcclxuICAgICAgICAgICAgaGVpZ2h0OiAnOTAlJyxcclxuICAgICAgICAgICAgb25Mb2FkOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBjYWNoZWRTY3JvbGxQb3NpdGlvbiA9ICQoJ2h0bWwnKS5zY3JvbGxUb3AoKTtcclxuICAgICAgICAgICAgICAgIC8vIGhpZGUgdGhlIHNjcm9sbGJhcnMgZnJvbSB0aGUgbWFpbiB3aW5kb3dcclxuICAgICAgICAgICAgICAgICQoJ2h0bWwsIGJvZHknKS5jc3MoJ292ZXJmbG93JywgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBvbkNsb3NlZDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHNlbGVjdGVkRGF0YSA9ICQuY29sb3Jib3guc2VsZWN0ZWREYXRhO1xyXG5cclxuICAgICAgICAgICAgICAgICQoJ2h0bWwsIGJvZHknKS5jc3MoJ292ZXJmbG93JywgJycpO1xyXG4gICAgICAgICAgICAgICAgJCgnaHRtbCcpLnNjcm9sbFRvcChjYWNoZWRTY3JvbGxQb3NpdGlvbik7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHNlbGVjdGVkRGF0YS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGluc3RhbmNlLiRlbC5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnZWRpdG9yOmFkZE1lZGlhJywge1xyXG4gICAgICAgICAgICAgICAgICAgIGRldGFpbDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUl0ZW1zOiBzZWxlY3RlZERhdGFcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxufSk7IiwiLyoqXHJcbiAqIEVkaXRvciBjYW4gYmUgcmVzaXplZCB0byBjdXN0b20gaGVpZ2h0LlxyXG4gKi9cclxuXHJcbndpbmRvdy5FZGl0b3IucGx1Z2lucy5wdXNoKHtcclxuICAgIGFjdGlvbjogJ3Jlc2l6ZScsXHJcbiAgICBpbml0OiB0cnVlLFxyXG4gICAgZXhlYzogZnVuY3Rpb24gKGluc3RhbmNlKSB7XHJcbiAgICAgICAgdmFyIGluaXRpYWxZLCBpbml0aWFsSGVpZ2h0LFxyXG4gICAgICAgICAgICAkcmVzaXplciA9IGluc3RhbmNlLiRlbC5xdWVyeVNlbGVjdG9yKCcuanMtZWRpdG9yLXJlc2l6ZXInKTtcclxuICAgICAgICBcclxuICAgICAgICB2YXIgZGlzcG9zZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG9uRHJhZyk7XHJcbiAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZGlzcG9zZSk7XHJcbiAgICAgICAgICAgIGluc3RhbmNlLiR2aXN1YWxJRnJhbWUuY29udGVudFdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBvbklGcmFtZURyYWcpO1xyXG4gICAgICAgICAgICBpbnN0YW5jZS4kdmlzdWFsSUZyYW1lLmNvbnRlbnRXaW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGRpc3Bvc2UpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBvbkRyYWcgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICBpbnN0YW5jZS4kZWwuc3R5bGUuaGVpZ2h0ID0gKGluaXRpYWxIZWlnaHQgKyAoZS5jbGllbnRZIC0gaW5pdGlhbFkpKSArICdweCc7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIG9uSUZyYW1lRHJhZyA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgIHZhciBib3VuZGluZ0NsaWVudFJlY3QgPSBpbnN0YW5jZS4kdmlzdWFsSUZyYW1lLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLFxyXG4gICAgICAgICAgICAgICAgZXZ0ID0gbmV3IEN1c3RvbUV2ZW50KCdtb3VzZW1vdmUnLCB7IGJ1YmJsZXM6IHRydWUsIGNhbmNlbGFibGU6IGZhbHNlIH0pO1xyXG5cclxuICAgICAgICAgICAgZXZ0LmNsaWVudFggPSBlLmNsaWVudFggKyBib3VuZGluZ0NsaWVudFJlY3QubGVmdDtcclxuICAgICAgICAgICAgZXZ0LmNsaWVudFkgPSBlLmNsaWVudFkgKyBib3VuZGluZ0NsaWVudFJlY3QudG9wO1xyXG5cclxuICAgICAgICAgICAgaW5zdGFuY2UuJHZpc3VhbElGcmFtZS5kaXNwYXRjaEV2ZW50KGV2dCk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgJHJlc2l6ZXIuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgaW5pdGlhbFkgPSBlLmNsaWVudFk7XHJcbiAgICAgICAgICAgIGluaXRpYWxIZWlnaHQgPSBpbnN0YW5jZS4kZWwub2Zmc2V0SGVpZ2h0O1xyXG5cclxuICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG9uRHJhZyk7XHJcbiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZGlzcG9zZSk7XHJcbiAgICAgICAgICAgIGluc3RhbmNlLiR2aXN1YWxJRnJhbWUuY29udGVudFdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBvbklGcmFtZURyYWcpO1xyXG4gICAgICAgICAgICBpbnN0YW5jZS4kdmlzdWFsSUZyYW1lLmNvbnRlbnRXaW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGRpc3Bvc2UpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59KTsiLCIoZnVuY3Rpb24gKCkge1xyXG4gICAgdmFyIGVkaXRvckluc3RhbmNlID0gZnVuY3Rpb24gKCRlbCkge1xyXG4gICAgICAgIHZhciBlZGl0b3IsIHNlc3Npb24sICRpbnB1dDtcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogQWRkIHByb3ZpZGVkIG1lZGlhIHRvIGVkaXRvciwgZGljdGF0ZWQgYnkgY3VycmVudCBhY2UgZWRpdG9yIHNlbGVjdGlvbiBzdGF0ZS5cclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgYWRkTWVkaWEgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICBpZiAoIWUgfHwgIWUuZGV0YWlsIHx8ICFlLmRldGFpbC5tZWRpYUl0ZW1zKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHZhciBhbHQsIGN1cnNvclBvc2l0aW9uLCBsaW5lLCB1cmw7XHJcblxyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGUuZGV0YWlsLm1lZGlhSXRlbXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHN3aXRjaCAoZS5kZXRhaWwubWVkaWFJdGVtc1tpXS5jb250ZW50VHlwZS50b0xvd2VyQ2FzZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnZG9jdW1lbnQnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnNlcnREb2N1bWVudChlLmRldGFpbC5tZWRpYUl0ZW1zW2ldKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnaW1hZ2UnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnNlcnRJbWFnZShlLmRldGFpbC5tZWRpYUl0ZW1zW2ldKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBGaWx0ZXJzIG91dCB1bndhbnRlZCBhbm5vdGF0aW9ucyAoZS5nLiB3YXJuaW5nIGFib3V0IGRvY3R5cGUpIGR1ZSB0byBjb21tb25cclxuICAgICAgICAgKiBjYXNlIGlzIHRoZSBIVE1MIGJlaW5nIGVkaXRlZCBpcyBub3QgYSBmdWxsIEhUTUwgZG9jdW1lbnQgYnV0IGEgcGllY2Ugb2YgSFRNTC5cclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgZmlsdGVyQW5ub3RhdGlvbiA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIGFubm90YXRpb25zID0gc2Vzc2lvbi5nZXRBbm5vdGF0aW9ucygpIHx8IFtdLCBpID0gbGVuID0gYW5ub3RhdGlvbnMubGVuZ3RoO1xyXG5cclxuICAgICAgICAgICAgd2hpbGUgKGktLSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKC9kb2N0eXBlIGZpcnN0XFwuIEV4cGVjdGVkLy50ZXN0KGFubm90YXRpb25zW2ldLnRleHQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYW5ub3RhdGlvbnMuc3BsaWNlKGksIDEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAobGVuID4gYW5ub3RhdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBzZXNzaW9uLnNldEFubm90YXRpb25zKGFubm90YXRpb25zKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFJldHVybnMgdGV4dGFyZWEgdGhhdCBuZWVkcyB0byBnZXQgdHVybmVkIGludG8gQWNlIGVkaXRvci5cclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgZ2V0VGV4dEFyZWEgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAkZWwucXVlcnlTZWxlY3RvcignLmpzLWVkaXRvci1jb2RlID4gdGV4dGFyZWEnKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBJbml0aWFsaXNlcyBBY2UgZWRpdG9yLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciBpbml0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBlZGl0b3IgPSBhY2UuZWRpdChnZXRUZXh0QXJlYSgpLmlkKTtcclxuICAgICAgICAgICAgc2Vzc2lvbiA9IGVkaXRvci5nZXRTZXNzaW9uKCk7XHJcblxyXG4gICAgICAgICAgICAkaW5wdXQgPSAkZWwucXVlcnlTZWxlY3RvcignLmVkaXRvci1pbnB1dCcpO1xyXG5cclxuICAgICAgICAgICAgZWRpdG9yLnNldFRoZW1lKCdhY2UvdGhlbWUvbW9ub2thaScpO1xyXG4gICAgICAgICAgICBlZGl0b3Iuc2V0U2hvd1ByaW50TWFyZ2luKGZhbHNlKTtcclxuICAgICAgICAgICAgZWRpdG9yLiRibG9ja1Njcm9sbGluZyA9IEluZmluaXR5O1xyXG5cclxuICAgICAgICAgICAgc2Vzc2lvbi5zZXRNb2RlKCdhY2UvbW9kZS9odG1sJyk7XHJcbiAgICAgICAgICAgIHNlc3Npb24uc2V0VXNlV3JhcE1vZGUodHJ1ZSk7XHJcblxyXG4gICAgICAgICAgICBzZXNzaW9uLm9uKCdjaGFuZ2VBbm5vdGF0aW9uJywgZmlsdGVyQW5ub3RhdGlvbik7XHJcbiAgICAgICAgICAgIHNlc3Npb24ub24oJ2NoYW5nZScsIHVwZGF0ZSk7XHJcblxyXG4gICAgICAgICAgICAkaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgdXBkYXRlU2Vzc2lvbik7XHJcbiAgICAgICAgICAgICRlbC5hZGRFdmVudExpc3RlbmVyKCdlZGl0b3I6dmFsdWVVcGRhdGUnLCB1cGRhdGVTZXNzaW9uKTtcclxuICAgICAgICAgICAgJGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2VkaXRvcjphZGRNZWRpYScsIGFkZE1lZGlhKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBJbnNlcnRzIGh5cGVybGluayBmb3IgZG9jdW1lbnQuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIGluc2VydERvY3VtZW50ID0gZnVuY3Rpb24oYXNzZXQpIHtcclxuICAgICAgICAgICAgdmFyIGN1cnNvclBvc2l0aW9uID0gZWRpdG9yLnNlbGVjdGlvbi5nZXRSYW5nZSgpLnN0YXJ0LFxyXG4gICAgICAgICAgICAgICAgbGluZSA9IGVkaXRvci5zZXNzaW9uLmdldExpbmUoY3Vyc29yUG9zaXRpb24ucm93KTtcclxuXHJcbiAgICAgICAgICAgIC8vIGluc2VydGluZyBtZWRpYSBVUkwgYmV0d2VlbiB0d28gcXVvdGVzXHJcbiAgICAgICAgICAgIGlmIChsaW5lLnN1YnN0cihjdXJzb3JQb3NpdGlvbi5jb2x1bW4gLSA1LCA1KS50b0xvd2VyQ2FzZSgpID09PSAnaHJlZj1cIicpIHtcclxuICAgICAgICAgICAgICAgIGVkaXRvci5pbnNlcnQoYXNzZXQucmVzb3VyY2UpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBpbnNlcnRpbmcgbWVkaWEgVVJMIHdpdGggcXVvdGVzXHJcbiAgICAgICAgICAgIGlmIChsaW5lLnN1YnN0cihjdXJzb3JQb3NpdGlvbi5jb2x1bW4gLSA0LCA0KS50b0xvd2VyQ2FzZSgpID09PSAnaHJlZj0nKSB7XHJcbiAgICAgICAgICAgICAgICBlZGl0b3IuaW5zZXJ0KCdcIicgKyBhc3NldC5yZXNvdXJjZSArICdcIicpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBlbnN1cmUgdGhhdCB0aGUgY3VycmVudCBjdXJzb3IgcG9zaXRpb24gd2FycmFudHMgYSBjb21wbGV0ZSBhbmNob3IgSFRNTFxyXG4gICAgICAgICAgICAvLyB0YWcgaW5zdGVhZCBvZiB0aGUgVVJMLlxyXG4gICAgICAgICAgICB2YXIgY2hhcmFjdGVyID0gbGluZS5zdWJzdHIoY3Vyc29yUG9zaXRpb24uY29sdW1uIC0gMSwgMSkudG9Mb3dlckNhc2UoKVxyXG5cclxuICAgICAgICAgICAgaWYgKGNoYXJhY3RlciA9PT0gJz4nIHx8IGNoYXJhY3RlciA9PT0gJycgfHwgY2hhcmFjdGVyID09PSAnICcpIHtcclxuICAgICAgICAgICAgICAgIGVkaXRvci5pbnNlcnQoJzxhIGhyZWY9XCInICsgYXNzZXQucmVzb3VyY2UgKyAnXCIgdGl0bGU9XCInICsgYXNzZXQuYWx0ZXJuYXRlVGV4dCArICdcIiBjbGFzcz1cIlwiIC8+XFxuJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGVkaXRvci5pbnNlcnQoYXNzZXQucmVzb3VyY2UpOyAgICAgICAgXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBJbnNlcnRzIGFuIGltYWdlIGF0IHRoZSBjdXJyZW50IGN1cnNvciBwb3NpdGlvbi5cclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgaW5zZXJ0SW1hZ2UgPSBmdW5jdGlvbiAoaW1hZ2UpIHtcclxuICAgICAgICAgICAgdmFyIGN1cnNvclBvc2l0aW9uID0gZWRpdG9yLnNlbGVjdGlvbi5nZXRSYW5nZSgpLnN0YXJ0LFxyXG4gICAgICAgICAgICAgICAgbGluZSA9IGVkaXRvci5zZXNzaW9uLmdldExpbmUoY3Vyc29yUG9zaXRpb24ucm93KTtcclxuXHJcbiAgICAgICAgICAgIC8vIGluc2VydGluZyBtZWRpYSBVUkwgYmV0d2VlbiB0d28gcXVvdGVzXHJcbiAgICAgICAgICAgIGlmIChsaW5lLnN1YnN0cihjdXJzb3JQb3NpdGlvbi5jb2x1bW4gLSA1LCA1KS50b0xvd2VyQ2FzZSgpID09PSAnc3JjPVwiJykge1xyXG4gICAgICAgICAgICAgICAgZWRpdG9yLmluc2VydChpbWFnZS5yZXNvdXJjZSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIGluc2VydGluZyBtZWRpYSBVUkwgd2l0aCBxdW90ZXNcclxuICAgICAgICAgICAgaWYgKGxpbmUuc3Vic3RyKGN1cnNvclBvc2l0aW9uLmNvbHVtbiAtIDQsIDQpLnRvTG93ZXJDYXNlKCkgPT09ICdzcmM9Jykge1xyXG4gICAgICAgICAgICAgICAgZWRpdG9yLmluc2VydCgnXCInICsgaW1hZ2UucmVzb3VyY2UgKyAnXCInKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gaW5zZXJ0aW5nIG1lZGlhIGFzIGFuIGlubGluZSBzdHlsZVxyXG4gICAgICAgICAgICBpZiAobGluZS5zdWJzdHIoY3Vyc29yUG9zaXRpb24uY29sdW1uIC0gNCwgNCkudG9Mb3dlckNhc2UoKSA9PT0gJ3VybCgnKSB7XHJcbiAgICAgICAgICAgICAgICBlZGl0b3IuaW5zZXJ0KGltYWdlLnJlc291cmNlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gZW5zdXJlIHRoYXQgdGhlIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uIHdhcnJhbnRzIGEgY29tcGxldGUgaW1nIEhUTUxcclxuICAgICAgICAgICAgLy8gdGFnIGluc3RlYWQgb2YgdGhlIFVSTC5cclxuICAgICAgICAgICAgdmFyIGNoYXJhY3RlciA9IGxpbmUuc3Vic3RyKGN1cnNvclBvc2l0aW9uLmNvbHVtbiAtIDEsIDEpLnRvTG93ZXJDYXNlKClcclxuXHJcbiAgICAgICAgICAgIGlmIChjaGFyYWN0ZXIgPT09ICc+JyB8fCBjaGFyYWN0ZXIgPT09ICcnIHx8IGNoYXJhY3RlciA9PT0gJyAnKSB7XHJcbiAgICAgICAgICAgICAgICBlZGl0b3IuaW5zZXJ0KCc8aW1nIHNyYz1cIicgKyBpbWFnZS5yZXNvdXJjZSArICdcIiBhbHQ9XCInICsgaW1hZ2UuYWx0ZXJuYXRlVGV4dCArICdcIiBjbGFzcz1cIlwiIC8+XFxuJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGVkaXRvci5pbnNlcnQoaW1hZ2UucmVzb3VyY2UpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFVwZGF0ZXMgaGlkZGVuIEhUTUwgaW5wdXQgd2l0aCBsYXRlc3QgY29udGVudCBmcm9tIEFjZSBlZGl0b3IuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIHVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgJGlucHV0LnZhbHVlID0gc2Vzc2lvbi5nZXRWYWx1ZSgpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciB1cGRhdGVTZXNzaW9uID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBzZXNzaW9uLnNldFZhbHVlKCRpbnB1dC52YWx1ZSk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaW5pdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSW5pdGlhbGlzZXMgaW5zdGFuY2VzIG9mIHRoZSBBY2UgZWRpdG9yLlxyXG4gICAgICovXHJcbiAgICB2YXIgaW5pdGlhbGlzZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgJGVkaXRvcnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuanMtZWRpdG9yJyk7XHJcblxyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgJGVkaXRvcnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgZWRpdG9ySW5zdGFuY2UoJGVkaXRvcnNbaV0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGluaXRpYWxpc2UpO1xyXG59KSgpOyIsIihmdW5jdGlvbiAoKSB7XHJcbiAgICB2YXIgQ1NTX0NPREVfRURJVE9SID0gJ2lzLWNvZGUtZWRpdG9yJyxcclxuICAgICAgICBDU1NfVklTVUFMX0VESVRPUiA9ICdpcy12aXN1YWwtZWRpdG9yJztcclxuXHJcbiAgICB2YXIgZWRpdG9ySW5zdGFuY2UgPSBmdW5jdGlvbiAoJGVsKSB7XHJcbiAgICAgICAgdmFyIGluc3RhbmNlSWQgPSAkZWwuZ2V0QXR0cmlidXRlKCdkYXRhLWlkJyksXHJcbiAgICAgICAgICAgICR2aXN1YWxFZGl0b3IsICR2aXN1YWxFZGl0b3JJRnJhbWUsICRpbnB1dCwgJHJlc2l6ZXI7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogUmV0dXJucyB0aGUgdHlwZSBvZiBjb250ZW50XHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIGdldENvbnRlbnRUeXBlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmpzLWVkaXRvci1jb250ZW50LXR5cGUnKS52YWx1ZTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBSZXR1cm5zIG9iamVjdCByZXByZXNlbnRpbmcgaW5zdGFuY2UuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIGdldEluc3RhbmNlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgaWQ6IGluc3RhbmNlSWQsXHJcbiAgICAgICAgICAgICAgICAkZWw6ICRlbCxcclxuICAgICAgICAgICAgICAgICR2aXN1YWxJRnJhbWU6ICR2aXN1YWxFZGl0b3JJRnJhbWVcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFVzZXIgaGFzIGNsaWNrZWQgYW4gYWN0aW9uIHdpdGhpbiB0aGUgdG9vbGJhci5cclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgaGFuZGxlQWN0aW9uID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgdmFyIGFjdGlvbiA9IGUuY3VycmVudFRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtYWN0aW9uJyksXHJcbiAgICAgICAgICAgICAgICBwbHVnaW5zID0gd2luZG93LkVkaXRvci5wbHVnaW5zO1xyXG5cclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwbHVnaW5zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAocGx1Z2luc1tpXS5hY3Rpb24gPT09IGFjdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHBsdWdpbnNbaV0uZXhlYyhnZXRJbnN0YW5jZSgpKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHN3aXRjaCAoYWN0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlICd0b2dnbGUtY29kZS1lZGl0b3InOlxyXG4gICAgICAgICAgICAgICAgICAgIHRvZ2dsZUNvZGVFZGl0b3IoKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3RvZ2dsZS12aXN1YWwtZWRpdG9yJzpcclxuICAgICAgICAgICAgICAgICAgICB0b2dnbGVWaXN1YWxFZGl0b3IoKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogSW5pdGlhbGlzZXMgTWVkaXVtIGVkaXRvci5cclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgaW5pdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgJHZpc3VhbEVkaXRvciA9ICRlbC5xdWVyeVNlbGVjdG9yKCcuanMtZWRpdG9yLXZpc3VhbCcpO1xyXG4gICAgICAgICAgICAkaW5wdXQgPSAkZWwucXVlcnlTZWxlY3RvcignLmVkaXRvci1pbnB1dCcpO1xyXG4gICAgICAgICAgICAkdmlzdWFsRWRpdG9ySUZyYW1lID0gJGVsLnF1ZXJ5U2VsZWN0b3IoJy5qcy1lZGl0b3ItdmlzdWFsLWlmcmFtZScpO1xyXG5cclxuICAgICAgICAgICAgdmFyICRhY3Rpb25zID0gJGVsLnF1ZXJ5U2VsZWN0b3JBbGwoJy5qcy10b29sYmFyLWJ0bicpO1xyXG5cclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAkYWN0aW9ucy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgJGFjdGlvbnNbaV0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBoYW5kbGVBY3Rpb24pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIG9uTWVzc2FnZSk7XHJcblxyXG4gICAgICAgICAgICB0b2dnbGVDb2RlRWRpdG9yKCk7XHJcblxyXG4gICAgICAgICAgICAvLyBsb29wIG92ZXIgcGx1Z2lucyBhbmQgZXhlY3V0ZSBhbnkgdGhhdCBhcmUgZmxhZ2dlZCB0b1xyXG4gICAgICAgICAgICAvLyBleGVjIG9uIGluaXRpYWxpc2UuXHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgd2luZG93LkVkaXRvci5wbHVnaW5zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAod2luZG93LkVkaXRvci5wbHVnaW5zW2ldLmluaXQpIHtcclxuICAgICAgICAgICAgICAgICAgICB3aW5kb3cuRWRpdG9yLnBsdWdpbnNbaV0uZXhlYyhnZXRJbnN0YW5jZSgpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFJlY2VpdmVkIGEgbWVzc2FnZSBmcm9tIHRoZSBpZnJhbWUgZWRpdG9yLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciBvbk1lc3NhZ2UgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICBpZiAoZS5kYXRhLmlkICE9PSBpbnN0YW5jZUlkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChlLmRhdGEuYWN0aW9uID09PSAndXBkYXRlJykge1xyXG4gICAgICAgICAgICAgICAgJGlucHV0LnZhbHVlID0gaHRtbF9iZWF1dGlmeSA/IGh0bWxfYmVhdXRpZnkoZS5kYXRhLnZhbHVlLCB7IHdyYXBfbGluZV9sZW5ndGg6IDAgfSkgOiBlLmRhdGEudmFsdWU7XHJcbiAgICAgICAgICAgICAgICAkZWwuZGlzcGF0Y2hFdmVudChuZXcgRXZlbnQoJ2VkaXRvcjp2YWx1ZVVwZGF0ZScpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIERpc3BsYXlzIGNvZGUgZWRpdG9yLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciB0b2dnbGVDb2RlRWRpdG9yID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAkZWwuY2xhc3NMaXN0LnJlbW92ZShDU1NfVklTVUFMX0VESVRPUik7XHJcbiAgICAgICAgICAgICRlbC5jbGFzc0xpc3QuYWRkKENTU19DT0RFX0VESVRPUik7XHJcblxyXG4gICAgICAgICAgICAkZWwuZGlzcGF0Y2hFdmVudChuZXcgRXZlbnQoJ2VkaXRvcjp2YWx1ZVVwZGF0ZScpKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBEaXNwbGF5cyB2aXN1YWwgZWRpdG9yLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHZhciB0b2dnbGVWaXN1YWxFZGl0b3IgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIC8vIHNlbmQgaW5mb3JtYXRpb24gdG8gaWZyYW1lLlxyXG4gICAgICAgICAgICBzZW5kTWVzc2FnZSh7XHJcbiAgICAgICAgICAgICAgICBhY3Rpb246ICd1cGRhdGUnLFxyXG4gICAgICAgICAgICAgICAgdmFsdWU6ICRpbnB1dC52YWx1ZSxcclxuICAgICAgICAgICAgICAgIG1lZGlhUGF0aDogZ2V0Q29udGVudFR5cGUoKVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICRlbC5jbGFzc0xpc3QucmVtb3ZlKENTU19DT0RFX0VESVRPUik7XHJcbiAgICAgICAgICAgICRlbC5jbGFzc0xpc3QuYWRkKENTU19WSVNVQUxfRURJVE9SKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBTZW5kcyBhIG1lc3NhZ2UgdG8gdGhlIGlmcmFtZS5cclxuICAgICAgICAgKi9cclxuICAgICAgICB2YXIgc2VuZE1lc3NhZ2UgPSBmdW5jdGlvbiAobXNnKSB7XHJcbiAgICAgICAgICAgIG1zZy5pbnN0YW5jZUlkID0gaW5zdGFuY2VJZDtcclxuICAgICAgICAgICAgJHZpc3VhbEVkaXRvcklGcmFtZS5jb250ZW50V2luZG93LnBvc3RNZXNzYWdlKEpTT04uc3RyaW5naWZ5KG1zZyksICcqJyk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaW5pdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSW5pdGlhbGlzZXMgaW5zdGFuY2VzIG9mIHRoZSBBY2UgZWRpdG9yLlxyXG4gICAgICovXHJcbiAgICB2YXIgaW5pdGlhbGlzZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgJGVkaXRvcnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuanMtZWRpdG9yJyk7XHJcblxyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgJGVkaXRvcnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgZWRpdG9ySW5zdGFuY2UoJGVkaXRvcnNbaV0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGluaXRpYWxpc2UpO1xyXG59KSgpOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
