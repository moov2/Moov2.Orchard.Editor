!function(e,t,i,r){"use strict";function a(i,r){this.el=i,this.$el=e(i),this.templates=t.MediumInsert.Templates,this.core=this.$el.data("plugin_"+o),this.options=e.extend(!0,{},s,r),this._defaults=s,this._name=o,this.core.getEditor()&&(this.core.getEditor()._serializePreImages=this.core.getEditor().serialize,this.core.getEditor().serialize=this.editorSerialize),this.init()}var o="mediumInsert",n="OrchardMedia",s={label:'<span class="fa fa-camera"></span>',captions:!0,captionPlaceholder:"Type caption for image (optional)"};a.prototype.add=function(){var t,i=location.href.toLowerCase().indexOf("/admin/"),r=this;-1!==i&&(t=location.href.substr(0,i)+"/Admin/Orchard.MediaLibrary?dialog=true",e.colorbox({href:t,iframe:!0,reposition:!0,width:"90%",height:"90%",onLoad:function(){e("html, body").css("overflow","hidden")},onClosed:function(){var t=e.colorbox.selectedData;0!==t.length&&(r.addMedia(t),e("html, body").css("overflow",""))}}))},a.prototype.addImage=function(t,i){var r=this.$el.find(".medium-insert-active");if(r.is("p"))r.replaceWith('<figure class="medium-insert-active">'+r.html()+"</figure>"),r=this.$el.find(".medium-insert-active"),r.next().is("p")?this.core.moveCaret(r.next()):(r.after("<p><br></p>"),this.core.moveCaret(r.next()));else{var a=e('<figure class="medium-insert-active"></figure>');r.after(a),r=a}r.find("br").remove(),r.append('\n	<img src="'+t.resource+'" alt="'+(t.alternateText||"")+'" />\n'),t.caption&&r.append('	<figcaption contenteditable="true">'+t.caption+"</figcaption>\n"),this.core.triggerInput(),i&&(this.core.hideButtons(),r.find("img").click())},a.prototype.addMedia=function(e){for(var t=0;t<e.length;t++)switch(e[t].contentType){case"Image":this.addImage(e[t],t+1===e.length);break;default:continue}},a.prototype.editorSerialize=function(){var t=this._serializePreImages();return e.each(t,function(i){var r,a=e("<div />").html(t[i].value);a.find("figcaption, figure").removeAttr("contenteditable"),a.find("figure").removeClass("medium-insert-image"),a.find("figcaption").removeAttr("data-placeholder").removeClass("medium-insert-caption-placeholder"),a.find('*[class=""]').removeAttr("class"),r=a.children().last(),r.is("p")&1===r.children().length&&1===r.find("br").length&&r.remove(),t[i].value=a.html()}),t},a.prototype.events=function(){e(i).on("click",e.proxy(this,"unselectImage")),this.$el.on("click","figure img",e.proxy(this,"selectImage"))},a.prototype.getCore=function(){return this.core},a.prototype.init=function(){var e=this.$el.find("figure");e.attr("contenteditable",!1),e.find("figcaption").attr("contenteditable",!0),this.events()},a.prototype.selectImage=function(t){var i,r=this;this.core.options.enabled&&(t.stopPropagation(),i=e(t.target),this.$currentImage=i,this.$el.blur(),i.addClass("medium-insert-image-active"),i.closest(".medium-insert-images").addClass("medium-insert-active"),setTimeout(function(){r.options.captions&&r.core.addCaption(i.closest("figure"),r.options.captionPlaceholder)},50))},a.prototype.unselectImage=function(t){var i=e(t.target),r=this.$el.find(".medium-insert-image-active");return i.is("img")&&i.hasClass("medium-insert-image-active")?(r.not(i).removeClass("medium-insert-image-active"),void this.core.removeCaptions(i)):(r.removeClass("medium-insert-image-active"),i.is(".medium-insert-caption-placeholder")?this.core.removeCaptionPlaceholder(r.closest("figure")):i.is("figcaption")===!1&&this.core.removeCaptions(),void(this.$currentImage=null))},e.fn[o+n]=function(t){return this.each(function(){e.data(this,"plugin_"+o+n)||e.data(this,"plugin_"+o+n,new a(this,t))})}}(jQuery,window,document);