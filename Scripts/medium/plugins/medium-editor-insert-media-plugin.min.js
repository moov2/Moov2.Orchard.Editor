!function(e,t,i,o){"use strict";function a(i,o){this.el=i,this.$el=e(i),this.templates=t.MediumInsert.Templates,this.core=this.$el.data("plugin_"+n),this.options=e.extend(!0,{},s,o),this._defaults=s,this._name=n,this.core.getEditor()&&(this.core.getEditor()._serializePreImages=this.core.getEditor().serialize,this.core.getEditor().serialize=this.editorSerialize),this.init()}var n="mediumInsert",r="OrchardMedia",s={label:'<span class="fa fa-camera"></span>',captions:!0,captionPlaceholder:"Type caption for image (optional)"};a.prototype.add=function(){var t,i=location.href.toLowerCase().indexOf("/admin/"),o=this;-1!==i&&(t=location.href.substr(0,i)+"/Admin/Orchard.MediaLibrary?dialog=true",e.colorbox({href:t,iframe:!0,reposition:!0,width:"90%",height:"90%",onLoad:function(){e("html, body").css("overflow","hidden")},onClosed:function(){var t=e.colorbox.selectedData;0!==t.length&&o.addMedia(t)}}))},a.prototype.addImage=function(e){var t=this.$el.find(".medium-insert-active");t.is("p")&&(t.replaceWith('<figure class="medium-insert-active">'+t.html()+"</div>"),t=this.$el.find(".medium-insert-active"),t.next().is("p")?this.core.moveCaret(t.next()):(t.after("<p><br></p>"),this.core.moveCaret(t.next()))),t.find("br").remove(),t.append('\n	<img src="'+e.resource+'" alt="'+e.alternateText+'" />'),e.caption&&t.append('\n	<figcaption contenteditable="true">'+e.caption+"</figcaption>"),this.core.triggerInput(),this.core.hideButtons(),t.find("img").click()},a.prototype.addMedia=function(e){for(var t=0;t<e.length;t++)switch(e[t].contentType){case"Image":this.addImage(e[t]);break;default:continue}},a.prototype.editorSerialize=function(){var t=this._serializePreImages();return e.each(t,function(i){var o,a=e("<div />").html(t[i].value);a.find("figcaption, figure").removeAttr("contenteditable"),a.find("figure").removeClass("medium-insert-image"),a.find("figcaption").removeAttr("data-placeholder").removeClass("medium-insert-caption-placeholder"),a.find('*[class=""]').removeAttr("class"),o=a.children().last(),o.is("p")&1===o.children().length&&1===o.find("br").length&&o.remove(),t[i].value=a.html()}),t},a.prototype.events=function(){e(i).on("click",e.proxy(this,"unselectImage")),this.$el.on("click","figure img",e.proxy(this,"selectImage"))},a.prototype.getCore=function(){return this.core},a.prototype.init=function(){var e=this.$el.find("figure");e.attr("contenteditable",!1),e.find("figcaption").attr("contenteditable",!0),this.events()},a.prototype.selectImage=function(t){var i,o=this;this.core.options.enabled&&(t.stopPropagation(),i=e(t.target),this.$currentImage=i,this.$el.blur(),i.addClass("medium-insert-image-active"),i.closest(".medium-insert-images").addClass("medium-insert-active"),setTimeout(function(){o.options.captions&&o.core.addCaption(i.closest("figure"),o.options.captionPlaceholder)},50))},a.prototype.unselectImage=function(t){var i=e(t.target),o=this.$el.find(".medium-insert-image-active");return i.is("img")&&i.hasClass("medium-insert-image-active")?(o.not(i).removeClass("medium-insert-image-active"),void this.core.removeCaptions(i)):(o.removeClass("medium-insert-image-active"),i.is(".medium-insert-caption-placeholder")?this.core.removeCaptionPlaceholder(o.closest("figure")):i.is("figcaption")===!1&&this.core.removeCaptions(),void(this.$currentImage=null))},e.fn[n+r]=function(t){return this.each(function(){e.data(this,"plugin_"+n+r)||e.data(this,"plugin_"+n+r,new a(this,t))})}}(jQuery,window,document);