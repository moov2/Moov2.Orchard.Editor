!function(e,t,i,a){"use strict";function r(i,a){this.el=i,this.$el=e(i),this.templates=t.MediumInsert.Templates,this.core=this.$el.data("plugin_"+o),this.options=e.extend(!0,{},s,a),this._defaults=s,this._name=o,this.core.getEditor()&&(this.core.getEditor()._serializePreImages=this.core.getEditor().serialize,this.core.getEditor().serialize=this.editorSerialize),this.init()}var o="mediumInsert",n="OrchardMedia",s={label:'<span class="fa fa-camera"></span>',captions:!0,captionPlaceholder:"Type caption for image (optional)"};r.prototype.add=function(){var t,i=location.href.toLowerCase().indexOf("/admin/"),a=this;-1!==i&&(t=location.href.substr(0,i)+"/Admin/Orchard.MediaLibrary?dialog=true",e.colorbox({href:t,iframe:!0,reposition:!0,width:"90%",height:"90%",onLoad:function(){e("html, body").css("overflow","hidden")},onClosed:function(){var t=e.colorbox.selectedData;0!==t.length&&a.addMedia(t)}}))},r.prototype.addImage=function(t,i){var a=this.$el.find(".medium-insert-active");if(a.is("p"))a.replaceWith('<figure class="medium-insert-active">'+a.html()+"</figure>"),a=this.$el.find(".medium-insert-active"),a.next().is("p")?this.core.moveCaret(a.next()):(a.after("<p><br></p>"),this.core.moveCaret(a.next()));else{var r=e('<figure class="medium-insert-active"></figure>');a.after(r),a=r}a.find("br").remove(),a.append('\n	<img src="'+t.resource+'" alt="'+(t.alternateText||"")+'" />'),t.caption&&a.append('\n	<figcaption contenteditable="true">'+t.caption+"</figcaption>"),this.core.triggerInput(),i&&(this.core.hideButtons(),a.find("img").click())},r.prototype.addMedia=function(e){for(var t=0;t<e.length;t++)switch(e[t].contentType){case"Image":this.addImage(e[t],t+1===e.length);break;default:continue}},r.prototype.editorSerialize=function(){var t=this._serializePreImages();return e.each(t,function(i){var a,r=e("<div />").html(t[i].value);r.find("figcaption, figure").removeAttr("contenteditable"),r.find("figure").removeClass("medium-insert-image"),r.find("figcaption").removeAttr("data-placeholder").removeClass("medium-insert-caption-placeholder"),r.find('*[class=""]').removeAttr("class"),a=r.children().last(),a.is("p")&1===a.children().length&&1===a.find("br").length&&a.remove(),t[i].value=r.html()}),t},r.prototype.events=function(){e(i).on("click",e.proxy(this,"unselectImage")),this.$el.on("click","figure img",e.proxy(this,"selectImage"))},r.prototype.getCore=function(){return this.core},r.prototype.init=function(){var e=this.$el.find("figure");e.attr("contenteditable",!1),e.find("figcaption").attr("contenteditable",!0),this.events()},r.prototype.selectImage=function(t){var i,a=this;this.core.options.enabled&&(t.stopPropagation(),i=e(t.target),this.$currentImage=i,this.$el.blur(),i.addClass("medium-insert-image-active"),i.closest(".medium-insert-images").addClass("medium-insert-active"),setTimeout(function(){a.options.captions&&a.core.addCaption(i.closest("figure"),a.options.captionPlaceholder)},50))},r.prototype.unselectImage=function(t){var i=e(t.target),a=this.$el.find(".medium-insert-image-active");return i.is("img")&&i.hasClass("medium-insert-image-active")?(a.not(i).removeClass("medium-insert-image-active"),void this.core.removeCaptions(i)):(a.removeClass("medium-insert-image-active"),i.is(".medium-insert-caption-placeholder")?this.core.removeCaptionPlaceholder(a.closest("figure")):i.is("figcaption")===!1&&this.core.removeCaptions(),void(this.$currentImage=null))},e.fn[o+n]=function(t){return this.each(function(){e.data(this,"plugin_"+o+n)||e.data(this,"plugin_"+o+n,new r(this,t))})}}(jQuery,window,document);